---
import MainLogo from "@/logos/Head-Transparent.png"
import "@/styles/global.css"
import "@/styles/navbar.css"
---

<nav class="navbar">
  <div class="mobile-header">
    <div class="brand">
      <a href="/">
        <img src={MainLogo.src} alt="Main Logo" class="logo" />
      </a>
    </div>

    <button class="hamburger" id="menu-toggle">&#9776;</button>
  </div>

  <ul class="nav-links main-links" id="main-links">
<!-- 
    <li class="dropdown">
      <a href="#" class="dropbtn">
        Learn <span class="arrow">&#9662;</span>
      </a>
      <ul class="dropdown-content">
        <li><a href="/learn/ai_tools">AI Tools & Resources</a></li>
        <li><a href="/learn/ml_topics">ML Topics</a></li>
        <li><a href="/learn/ml_playground">ML Playground</a></li>
      </ul>
    </li> -->

    <li><a href="/about">About</a></li>
    <li><a href="/events">Events</a></li>
    <li><a href="/challenges">Projects</a></li>
    <li><a href="/learn/ml_topics">Learn</a></li>
    <li><a href="/challenges">Sponsors</a></li>
    <li><a href="/contact">Connect</a></li>

    <!-- For mobile only -->
    <div class="mobile-only">
      <li class="pink-button"><a href="https://campus.hellorubric.com/?tab=memberships&s=11397">Join!</a></li>
    </div>

    <div class="indicator"></div>
  </ul>

  <div class="secondary-links">
    <a href="https://campus.hellorubric.com/?tab=memberships&s=11397" class="btn btn-outline">
      <svg class="btn-border" viewBox="0 0 100 40" preserveAspectRatio="none">
        <rect x="1" y="1" width="98" height="38" rx="18" ry="18" />
      </svg>
      <span>Join!</span>
    </a>
  </div>
</nav>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggleButton = document.getElementById("menu-toggle");
  const mainLinks    = document.getElementById("main-links");
  const body         = document.body;

toggleButton.addEventListener("click", e => {
  e.stopPropagation();

  const isOpen = mainLinks.classList.toggle("show");
  body.classList.toggle("no-scroll");

  // ① If nav is opening, collapse all dropdowns
  if (isOpen) {
    document.querySelectorAll(".dropdown-content.show")
      .forEach(el => el.classList.remove("show"));
    document.querySelectorAll(".dropbtn.open")
      .forEach(btn => btn.classList.remove("open"));
  }

  // ② Swap hamburger icon
  if (isOpen) {
    toggleButton.innerHTML = "&times;";
    toggleButton.classList.add("open");
  } else {
    toggleButton.innerHTML = "&#9776;";
    toggleButton.classList.remove("open");
  }
});

  // Dropdown buttons → toggle submenus AND arrows
  document.querySelectorAll(".dropdown > .dropbtn")
    .forEach(btn => {
      btn.addEventListener("click", e => {
        // On desktop (min-width: 768px), do nothing (hover in CSS handles it)
        if (window.matchMedia("(min-width: 768px)").matches) return;

        // Mobile: toggle submenu as before
        e.preventDefault();
        e.stopPropagation();

        const submenu = btn.parentElement.querySelector(".dropdown-content");
        const isOpen  = submenu.classList.contains("show");

        // close all others
        document.querySelectorAll(".dropdown-content.show")
          .forEach(m => m.classList.remove("show"));
        document.querySelectorAll(".dropbtn.open")
          .forEach(b => b.classList.remove("open"));

        if (isOpen) {
          submenu.classList.remove("show");
          btn.classList.remove("open");
        } else {
          submenu.classList.add("show");
          btn.classList.add("open");
        }
      });
    });

  const closeButton = document.getElementById("close-menu");
  if (closeButton) {
    closeButton.addEventListener("click", (e) => {
      e.stopPropagation();
      mainLinks.classList.remove("show");
      body.classList.remove("no-scroll");
    });
  }
});
</script>

<script type="module" client:load>
  const navContainer = document.querySelector('.nav-links');
  const links = Array.from(
    navContainer.querySelectorAll('a:not(.dropdown-content a)')
  );
  const indicator = navContainer.querySelector('.indicator');

  let activeLink = null;
  let indicatorTimeout = null;
  const currentPath = window.location.pathname;

  /* -----------------------------
     ACTIVE LINK DETECTION
  ----------------------------- */

  // 1) Exact match
  activeLink = links.find(
    link => link.getAttribute('href') === currentPath
  );

  // 2) Prefix match (ignore home "/")
  if (!activeLink) {
    activeLink = links.find(link => {
      const href = link.getAttribute('href');
      return href !== '/' && currentPath.startsWith(href);
    });
  }

  // 3) Dropdown children → parent toggle
  if (!activeLink) {
    document.querySelectorAll('.dropdown').forEach(drop => {
      const toggle = drop.querySelector('.dropbtn');
      const children = drop.querySelectorAll('.dropdown-content a');

      children.forEach(child => {
        const href = child.getAttribute('href');
        if (
          href === currentPath ||
          (href !== '/' && currentPath.startsWith(href))
        ) {
          activeLink = toggle;
        }
      });
    });
  }

  /* -----------------------------
     INDICATOR HELPERS
  ----------------------------- */

  function updateIndicator(linkEl) {
    const linkBox = linkEl.getBoundingClientRect();
    const containerBox = navContainer.getBoundingClientRect();
    const offsetX = linkBox.left - containerBox.left;

    indicator.style.width = `${linkBox.width}px`;
    indicator.style.left = `${offsetX}px`;
    indicator.classList.add('visible');
  }

  function hideIndicator() {
    indicator.classList.remove('visible');
  }

  /* -----------------------------
     INITIAL STATE
  ----------------------------- */

  if (activeLink) {
    activeLink.classList.add('active');
    updateIndicator(activeLink);
  } else {
    hideIndicator(); // HOME PAGE → no indicator
  }

  /* -----------------------------
     HOVER BEHAVIOR
  ----------------------------- */

  links.forEach(link => {
    link.addEventListener('mouseenter', () => {
      clearTimeout(indicatorTimeout);
      updateIndicator(link);
    });
  });

  /* -----------------------------
     LEAVE NAVBAR
  ----------------------------- */

  navContainer.addEventListener('mouseleave', () => {
    clearTimeout(indicatorTimeout);
    indicatorTimeout = setTimeout(() => {
      if (activeLink) {
        updateIndicator(activeLink);
      } else {
        hideIndicator(); // HOME → disappear entirely
      }
    }, 100);
  });

  /* -----------------------------
     SECONDARY CONTACT LINK
  ----------------------------- */

  document.addEventListener('DOMContentLoaded', () => {
    const contactLink = document.querySelector('.secondary-links a.contact');
    if (!contactLink) return;

    let path = window.location.pathname.replace(/\/$/, '');
    path = path.replace(/(\/index\.html)$/, '');

    if (path === '/contact') {
      contactLink.classList.add('active');
    }
  });
</script>
