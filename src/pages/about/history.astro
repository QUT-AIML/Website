---
import "@/styles/global.css";
import "@/styles/about/history.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";

// ----------------------------------------------------
// Step 1: Import all team-details.json files dynamically
// ----------------------------------------------------
const rawTeamFiles = import.meta.glob('/public/data/about/*/team-details.json', { eager: true });

// ----------------------------------------------------
// Step 2: Map to year + path, ignore non-numeric folders like Template
// ----------------------------------------------------
const teamsByYear = Object.keys(rawTeamFiles)
  .map(path => {
    const folderName = path.split("/").at(-2);
    const year = parseInt(folderName);
    return { path, year, valid: /^\d{4}$/.test(folderName) };
  })
  .filter(f => f.valid)
  .sort((a, b) => b.year - a.year); // descending

// ----------------------------------------------------
// Step 3: Normalize data with executiveList and teamPhoto
// ----------------------------------------------------
// Also check if team-photo.png exists in the folder
const photoFiles = import.meta.glob('/public/data/about/*/team-photo.png', { eager: true });

const teamsData = teamsByYear.map(({ year, path }) => {
  const teamJson = rawTeamFiles[path].default;

  // Normalize exec images
  const executiveList = teamJson.map(section => ({
    ...section,
    items: section.items.map(member => ({
      ...member,
      image: member.image
        ? `/data/about/${year}/exec-photos/${member.image}`
        : null,
    })),
  }));

  // Check if team-photo.png exists
  const photoPathCandidate = `/public/data/about/${year}/team-photo.png`;
  const teamPhoto = photoFiles[photoPathCandidate] ? `/data/about/${year}/team-photo.png` : null;

  return { year, executiveList, teamPhoto };
});

// ----------------------------------------------------
// Step 4: Helper function to group members by role
// ----------------------------------------------------
function groupByRole(items) {
  const map = {};
  items.forEach(p => {
    if (!map[p.role]) map[p.role] = [];
    map[p.role].push(p.name);
  });
  return map;
}
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning."
    />
    <title>QUT AI & ML Society</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <div class="content-wrapper history-space">
      <div class="info-panel-wrapper">
        <div class="thick-line-behind"></div>

        {teamsData.map(({ year, executiveList, teamPhoto }, yearIndex) => {
          const sectionTitle = `Team ${year}`;

          return (
            <>
              <section class="pink-panel full-width-banner">
                <p class="pink-title">
                  {year === 2025 ? "Founding (2025) Team" : year + " Team"}
                </p>
              </section>

              <section class="info-panel history-box" key={yearIndex}>
                <div class="team-split static-layout">

                  {/* LEFT: Yearbook Table */}
                  <aside class="yearbook">
                    <table class="yearbook-table">
                      {executiveList.map((team, index, arr) => {
                        const grouped = groupByRole(team.items);
                        return (
                          <>
                            <tbody class="team-group" key={team.title}>
                              {Object.entries(grouped).map(([role, names]) => (
                                <tr class="yearbook-row" key={role}>
                                  <td class="role-cell">{role}</td>
                                  <td class="names-cell">{names.join(', ')}</td>
                                </tr>
                              ))}
                            </tbody>

                            {index < arr.length - 1 && (
                              <tbody>
                                <tr class="team-spacer">
                                  <td colSpan="2"></td>
                                </tr>
                              </tbody>
                            )}
                          </>
                        );
                      })}
                    </table>
                  </aside>

                  {/* RIGHT: Hero Image with Loader */}
                  <div class="team-photo-large">
                    {teamPhoto ? (
                      <div class="image-wrapper" style="position: relative;">
                        <div class="loader" id={`loader-${yearIndex}`}>
                          <div class="spinner"></div>
                        </div>
                        <img
                          src={teamPhoto}
                          alt={sectionTitle}
                          class="team-hero"
                          id={`teamHero-${yearIndex}`}
                          onload={`document.getElementById('loader-${yearIndex}').style.display='none'`}
                          style="display: block;"
                        />
                      </div>
                    ) : (
                      <div class="team-placeholder">
                        Photo coming soon!
                      </div>
                    )}
                  </div>

                  {/* Modal */}
                  <div id={`photoModal-${yearIndex}`} class="modal">
                    <span class="modal-close" id={`modalClose-${yearIndex}`}>&times;</span>
                    <img class="modal-content" id={`modalImg-${yearIndex}`} />
                  </div>

                </div>
              </section>
            </>
          );
        })}
      </div>
    </div>

    <Footer />

    <script>
      // Handle multiple modals automatically
      document.querySelectorAll('.team-hero').forEach((img, i) => {
        const modal = document.getElementById(`photoModal-${i}`);
        const modalImg = document.getElementById(`modalImg-${i}`);
        const closeBtn = document.getElementById(`modalClose-${i}`);

        img.onclick = () => {
          modal.style.display = "block";
          modalImg.src = img.src;
          document.body.classList.add("modal-open");
        }

        closeBtn.onclick = () => {
          modal.style.display = "none";
          document.body.classList.remove("modal-open");
        }

        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
            document.body.classList.remove("modal-open");
          }
        }
      });
    </script>
  </body>
</html>
