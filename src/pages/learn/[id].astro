---
import "@/styles/global.css";
import "@/styles/learn/learn-details.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";

// ----------------------------------------------------
// Step 0: Export static paths for all learning pages
// ----------------------------------------------------
export async function getStaticPaths() {
  const rawLearnFiles = import.meta.glob('/public/data/learn/data/*.json', { eager: true });
  const paths = [];

  for (const mod of Object.values(rawLearnFiles)) {
    const data = mod.default;
    const items = Array.isArray(data) ? data : [data];

    items.forEach((ev) => {
      const slug = ev.title
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, "")
        .replace(/\s+/g, "-");

      paths.push({
        params: { id: slug },
      });
    });
  }

  return paths;
}

// ----------------------------------------------------
// Step 1: Get route param for current page
// ----------------------------------------------------
const { params } = Astro;
const idSlug = params.id;

// ----------------------------------------------------
// Step 2: Load all learnings
// ----------------------------------------------------
const rawLearnFiles = import.meta.glob('/public/data/learn/data/*.json', { eager: true });

const learnings = Object.values(rawLearnFiles)
  .map(mod => mod.default)
  .flat()
  .map(ev => {
    const slug = ev.title
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, "")
      .replace(/\s+/g, "-");

    return {
      ...ev,
      slug,
      image: ev.image ? `/data/learn/data/images/${ev.image}` : null,
      dateLabel: ev.date
        ? new Date(ev.date).toLocaleDateString("en-GB", {
            weekday: "long",
            day: "numeric",
            month: "short",
            year: "numeric"
          })
        : "",
    };
  });

// ----------------------------------------------------
// Step 3: Find the specific learning
// ----------------------------------------------------
const learning = learnings.find(ev => ev.slug === idSlug);
const notFound = !learning;

// ----------------------------------------------------
// Step 4: Utility function for formatted date
// ----------------------------------------------------
function formatDate(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat("en-GB", {
    weekday: "long",
    day: "numeric",
    month: "short",
    year: "numeric"
  }).format(date);
}
---


<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <meta name="description" content={learning?.description ?? "Learning resource"} />
  <title>{learning?.title ?? "Learning"} — QUT AIML</title>
</head>

<body class="background-dots">
  <Navigation />

  <main class="learn-detail-space">
    {notFound ? (
      <section class="learn-detail-card">
        <h1>Learning not found</h1>
        <a href="/learn" class="learn-link">← Back to Learn</a>
      </section>
    ) : (
      <article class="learn-detail-card">

        <!-- BACK -->
        <nav class="learn-back">
          <a href="/learn" class="learn-link">← Back to Learn</a>
        </nav>

        <!-- TITLE -->
        <h1 class="learn-title">{learning.title}</h1>

        <!-- META -->
        <div class="learn-meta">
          {learning.dateLabel && <span class="meta-pill">{learning.dateLabel}</span>}
          {learning.category && <span class="meta-pill">{learning.category}</span>}
        </div>

        <!-- DIVIDER -->
        <div class="learn-divider"></div>

        <!-- DESCRIPTION -->
        {learning.description && (
          <section class="learn-description">
            <h3>Overview</h3>
            <p>{learning.description}</p>
          </section>
        )}

        <!-- HERO IMAGE -->
        {learning?.image && (
          <section class="learn-hero">
            <img src={learning.image} alt={learning.title} />
          </section>
        )}

        <!-- DEFINITION -->
        {learning.overview?.definition && (
          <section class="learn-section">
            <h3>Definition</h3>
            <p>{learning.overview.definition}</p>
          </section>
        )}

        <!-- TYPES -->
        {learning.overview?.types && learning.overview.types.length > 0 && (
          <section class="learn-section">
            <h3>Types / Variants</h3>
            <ul class="learn-bullets">
              {learning.overview.types.map((t, i) => <li key={i}>{t}</li>)}
            </ul>
          </section>
        )}

        <!-- KEY CONCEPTS -->
        {learning.overview?.key_concepts && learning.overview.key_concepts.length > 0 && (
          <section class="learn-section">
            <h3>Key Concepts</h3>
            <ul class="learn-bullets">
              {learning.overview.key_concepts.map((k, i) => <li key={i}>{k}</li>)}
            </ul>
          </section>
        )}

        <!-- TUTORIALS -->
        {learning.tutorials && learning.tutorials.length > 0 && (
          <section class="learn-section">
            <h3>Tutorials</h3>
            <ul class="learn-links">
              {learning.tutorials.map((t, i) => (
                <li key={i}>
                  <strong><a href={t.url} target="_blank" class="learn-link">{t.title}</a></strong>
                  <p>• {t.description}</p>
                </li>
              ))}
            </ul>
          </section>
        )}

        <!-- VIDEOS -->
        {learning.videos && learning.videos.length > 0 && (
          <section class="learn-section">
            <h3>Videos</h3>
            <div class="learn-video-grid">
              {learning.videos.map((v, i) => (
                <div key={i} class="learn-video-item">
                  <iframe src={v.url} title={v.title} allowfullscreen></iframe>
                  <p>• {v.description}</p>
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- APPLICATIONS -->
        {learning.applications && learning.applications.length > 0 && (
          <section class="learn-section">
            <h3>Applications</h3>
            <ul class="learn-bullets">
              {learning.applications.map((a, i) => <li key={i}>{a}</li>)}
            </ul>
          </section>
        )}

        <!-- RESOURCES -->
        {learning.resources && learning.resources.length > 0 && (
          <section class="learn-section">
            <h3>Resources</h3>
            <ul class="learn-links">
              {learning.resources.map((r, i) => (
                <li key={i}>
                  <a href={r.url} target="_blank" class="learn-link">• {r.title}</a>
                </li>
              ))}
            </ul>
          </section>
        )}

        <!-- TIPS -->
        {learning.tips && learning.tips.length > 0 && (
          <section class="learn-section learn-tips">
            <h3>Tips & Best Practices</h3>
            <ul class="learn-bullets">
              {learning.tips.map((t, i) => <li key={i}>{t}</li>)}
            </ul>
          </section>
        )}


      </article>
    )}
  </main>

  <Footer />
</body>
</html>
