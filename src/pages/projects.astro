---
import "@/styles/global.css";
import "@/styles/projects.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";

// -----------------------------
// Helpers
// -----------------------------
function isTBCProject(p) {
  return p?.overview?.title?.toLowerCase() === "tbc";
}

function formatSemesterLabel(label) {
  return label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();
}

// -----------------------------
// Step 1: Load all project.json files
// -----------------------------
const rawProjectFiles = import.meta.glob('/public/data/projects/*/*.json', { eager: true });

// -----------------------------
// Step 2: Map files into semesters
// -----------------------------
const semestersMap = {};
for (const [path, mod] of Object.entries(rawProjectFiles)) {
  const semesterId = path.split('/').at(-2);
  if (!semestersMap[semesterId]) semestersMap[semesterId] = [];
  semestersMap[semesterId].push(mod.default);
}

// -----------------------------
// Step 3: Flatten semesters and add image paths
// -----------------------------
const semesters = Object.entries(semestersMap).map(([id, projects]) => ({
  id,
  label: formatSemesterLabel(id.replace(/-/g, " ")),
  projects: projects.map(p => ({
    ...p,
    semesterId: id,
    image: p.image ? `/data/projects/${id}/images/${p.image}` : null
  }))
}));

// -----------------------------
// Step 4: Sort semesters newest first (sem-{num}-{year})
// -----------------------------
const sortedSemesters = [...semesters].sort((a, b) => {
  const [aSem, aNum, aYear] = a.id.split("-");
  const [bSem, bNum, bYear] = b.id.split("-");
  const yearDiff = parseInt(bYear) - parseInt(aYear);
  if (yearDiff !== 0) return yearDiff;
  return parseInt(bNum) - parseInt(aNum);
});

const latestSemester = sortedSemesters[0] ?? null;
const latestProjectsRaw = latestSemester?.projects ?? [];

// -----------------------------
// Step 5: Determine if latest semester is TBC
// -----------------------------
const latestIsTBC = latestProjectsRaw.length === 0 || latestProjectsRaw.every(isTBCProject);

// -----------------------------
// Step 6: Current projects
// -----------------------------
const currentProjects = latestIsTBC
  ? []
  : latestProjectsRaw.map(p => ({
      ...p,
      semesterId: latestSemester.id
    }));

// -----------------------------
// Step 7: Past projects (exclude TBC)
// -----------------------------
const pastProjects = sortedSemesters
  .filter(s => s.id !== latestSemester?.id || latestIsTBC)
  .flatMap(s =>
    (s.projects ?? [])
      .filter(p => !isTBCProject(p))
      .map(p => ({
        ...p,
        semesterId: s.id
      }))
  );

// -----------------------------
// Step 8: Build filter types from past projects
// -----------------------------
const preferred = ["CNN", "Linear Regression"];
const allTypesSet = new Set();

pastProjects.forEach(p => {
  const t = (p.type ?? p.category ?? "Other")?.toString() ?? "Other";
  allTypesSet.add(t);
});

let types = ["All"];
if (allTypesSet.size > 1) {
  const preferredExisting = preferred.filter(p => allTypesSet.has(p));
  const remaining = Array.from(allTypesSet).filter(t => !preferredExisting.includes(t));
  remaining.sort((a, b) => a.localeCompare(b));
  types = ["All", ...preferredExisting, ...remaining];
}

---


<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning."
    />
    <title>QUT AI & ML Society</title>
    <link rel="stylesheet" href="/styles/global.css" />
    <link rel="stylesheet" href="/styles/projects/projects.css" />
  </head>

  <body class="background-dots">
    <Navigation />

    <div class="content-wrapper top-projects-space">
      <!-- ABOUT -->
      <section class="pink-panel">
        <p class="pink-title">Club Projects</p>
      </section>

      <div class="info-panel-wrapper">
        <div class="thick-line-behind"></div>
        <section class="info-panel">
          The QUT AI & ML Society runs collaborative projects that bring students, researchers, and industry partners together to build practical AI and machine‑learning solutions. 
          Projects range from developer tools and data‑driven apps to research prototypes and everyday innovations, with clear roles for contributors at every skill level. 
          We pair hands‑on work with mentorship, workshops, and hackathons to help members learn, share code, and grow their portfolios while applying AI responsibly. 
          Join to contribute, learn from peers, and help shape projects that make a real impact.
        </section>
      </div>

      <!-- CURRENT PROJECTS -->
      <section class="pink-panel current-projects-space">
        <p class="pink-title">Current Projects ({latestSemester.label})</p>
      </section>

      {currentProjects.length === 0 ? (
        <div class="info-panel-wrapper full-width-panel">
          <section class="info-panel">
            Latest project is still to be confirmed at this stage
          </section>
        </div>
      ) : (
        <section class="projects-panel current-projects-panel">
          <section id="current-projects-grid" class="projects-grid">
            {currentProjects.map(ev => {
              const type = ev.type ?? ev.category ?? "Other";
              return (
                <article
                  class="project-card"
                  data-semester={ev.semesterId}
                  data-category={ev.category}
                  data-type={type}
                  data-title={ev.title.toLowerCase()}
                >
                  <a href={ev.github} target="_blank" rel="noopener noreferrer">
                    <div class="card-media">
                      {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                    </div>

                    <div class="card-body">
                      <h3 class="card-title">{ev.title}</h3>
                      <div class="card-divider"></div>
                      <time class="card-date">{ev.dateLabel}</time>
                      <p class="card-description">{ev.excerpt}</p>
                      <div class="card-footer">
                        <span class="card-view-more">View on GitHub →</span>
                      </div>
                    </div>
                  </a>
                </article>
              );
            })}
          </section>
        </section>
      )}


      <section class="pink-panel past-projects-space">
        <p class="pink-title">Previous Projects</p>
      </section>

      <div class="key-content">
        <div class="projects-controls">
          <div class="controls-row">

            <!-- MOBILE SEARCH + FILTER WRAPPER -->
            <div class="mobile-search-filter">
              <div class="search-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="11" cy="11" r="7" />
                  <line x1="16.65" y1="16.65" x2="21" y2="21" />
                </svg>
                <input
                  id="projects-search"
                  type="search"
                  placeholder="Search projects"
                  aria-label="Search projects"
                />
              </div>
            </div>

            <!-- DESKTOP TYPE FILTERS -->
            <span class="type-filter-label">Sort by:</span>
            <div class="type-scroll-wrapper">
              <button class="type-scroll-btn left" aria-label="Scroll left">‹</button>

              <div id="type-filters" class="type-filter-pill scrollable">
                {types.map(t => (
                  <button
                    class={`type-btn ${t === "All" ? "active" : ""}`}
                    data-type={t}
                    type="button"
                  >
                    {t}
                  </button>
                ))}
              </div>

              <button class="type-scroll-btn right" aria-label="Scroll right">›</button>
            </div>


            <button id="filters-toggle" aria-haspopup="true" aria-expanded="false" type="button" class="filters-toggle-btn">
              <svg class="filters-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z"/>
              </svg>
            </button>

            <!-- FILTER POPOVER -->
            <div class="type-filter-wrapper" style="margin-left:auto; position:relative;">
              <div id="filters-popover" role="dialog" aria-modal="false" class="filters-popover">
                <div class="filters-popover-content">

                  <div class="filter-group">
                    <label for="semester-select-pop">Semester</label>
                    <select id="semester-select-pop">
                      <option value="all" selected>All past semesters</option>
                      {semesters.filter(s => s.id !== latestSemester?.id).map(s => (
                        <option value={s.id}>{s.label}</option>
                      ))}
                    </select>
                  </div>

                  <div class="filter-group filter-type">
                    <label for="type-select-pop">Type</label>
                    <select id="type-select-pop">
                      {types.map(t => (
                        <option value={t}>{t}</option>
                      ))}
                    </select>
                  </div>

                  <div class="filter-group">
                    <label for="sort-select-pop">Sort data</label>
                    <select id="sort-select-pop">
                      <option value="" selected>None</option>
                      <option value="title-asc">Title Ascending</option>
                      <option value="title-desc">Title Descending</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <section class="projects-panel">

          <div id="type-filters" class="desktop-type-filters">

            <section id="projects-grid" class="projects-grid">
              {pastProjects.map((ev) => {
                const type = ev.type ?? ev.category ?? "Other";
                return (
                  <article
                    class="project-card"
                    data-semester={ev.semesterId}
                    data-category={ev.category}
                    data-type={type}
                    data-title={ev.title.toLowerCase()}
                  >
                    <a href={ev.github} target="_blank" rel="noopener noreferrer">
                      <div class="card-media">
                        {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                      </div>

                      <div class="card-body">
                        <h3 class="card-title">{ev.title}</h3>
                        <div class="card-divider"></div>
                        <time class="card-date">{ev.dateLabel}</time>
                        <p class="card-description">{ev.excerpt}</p>
                        <div class="card-footer">
                          <span class="card-view-more">View on GitHub →</span>
                        </div>
                      </div>
                    </a>
                  </article>
                );
              })}
            </section>

          </div>
        </section>

        <!-- Pagination container -->
        <div id="projects-pagination"></div>

      </div>
    </div>

    <Footer />
    </body>
    </htmll>
    
    
    
    
    <script type="module">
      document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('projects-search');
        const pastGrid = document.querySelector('#projects-grid');
        const paginationContainer = document.getElementById('projects-pagination');

        const semesterSelectPop = document.getElementById('semester-select-pop');
        const sortSelectPop = document.getElementById('sort-select-pop');
        const typeSelectPop = document.getElementById('type-select-pop');

        const filtersToggle = document.getElementById('filters-toggle');
        const filtersPopover = document.getElementById('filters-popover');

        const typePillContainer = document.getElementById('type-filters');
        const scrollLeftBtn = document.querySelector('.type-scroll-btn.left');
        const scrollRightBtn = document.querySelector('.type-scroll-btn.right');

        if (!pastGrid || !paginationContainer) return;

        // =============================
        // STATE
        // =============================
        let PROJECTS_PER_PAGE = window.innerWidth < 768 ? 3 : 6;
        let currentPage = 1;
        let currentSemester = 'all';
        let currentSort = '';
        let currentType = 'All';

        let filteredCards = [];
        let typeButtons = [];

        // =============================
        // HELPERS
        // =============================
        function getCards() {
          return Array.from(pastGrid.querySelectorAll('.project-card'));
        }

        function getSelectedType() {
          return window.innerWidth < 768
            ? typeSelectPop?.value || 'All'
            : currentType;
        }

        // =============================
        // TYPE PILL INITIALISATION
        // =============================
        function initTypePills() {
          if (!typePillContainer) return;

          typeButtons = Array.from(
            typePillContainer.querySelectorAll('.type-btn')
          );

          typeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              currentType = btn.dataset.type;

              // Update pill UI
              typeButtons.forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              // Sync mobile dropdown
              if (typeSelectPop) typeSelectPop.value = currentType;

              currentPage = 1;
              applyFilters();
            });
          });
        }

        // =============================
        // FILTERING
        // =============================
        function applyFilters() {
          const query = searchInput.value.trim().toLowerCase();
          const selectedType = getSelectedType();

          filteredCards = getCards().filter(card => {
            const title = card.dataset.title || '';
            const excerpt =
              card.querySelector('.card-description')?.textContent.toLowerCase() || '';
            const cardType = card.dataset.type || '';
            const cardSemester = card.dataset.semester || '';

            return (
              (!query || title.includes(query) || excerpt.includes(query)) &&
              (selectedType === 'All' || cardType === selectedType) &&
              (currentSemester === 'all' || cardSemester === currentSemester)
            );
          });

          applySort();
          currentPage = 1;
          renderPage();
          renderPagination();
        }

        // =============================
        // SORTING
        // =============================
        function applySort() {
          if (!currentSort) return;

          filteredCards.sort((a, b) => {
            const aTitle = a.querySelector('.card-title')?.textContent || '';
            const bTitle = b.querySelector('.card-title')?.textContent || '';

            if (currentSort === 'title-asc') {
              return aTitle.localeCompare(bTitle, undefined, { sensitivity: 'base' });
            }
            if (currentSort === 'title-desc') {
              return bTitle.localeCompare(aTitle, undefined, { sensitivity: 'base' });
            }
            return 0;
          });
        }

        // =============================
        // PAGINATION
        // =============================
        function renderPage(scrollToTop = false) {
          const start = (currentPage - 1) * PROJECTS_PER_PAGE;
          const end = start + PROJECTS_PER_PAGE;

          getCards().forEach(card => (card.style.display = 'none'));
          filteredCards.slice(start, end).forEach(card => (card.style.display = ''));

          if (scrollToTop && filteredCards[start]) {
            const offset = 300;
            const top =
              filteredCards[start].getBoundingClientRect().top +
              window.scrollY -
              offset;
            window.scrollTo({ top, behavior: 'smooth' });
          }
        }

        function renderPagination() {
          const totalPages = Math.ceil(filteredCards.length / PROJECTS_PER_PAGE);
          paginationContainer.innerHTML = '';

          if (totalPages <= 1) return;

          const createBtn = (label, page, disabled = false, active = false) => {
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.className = `pagination-btn${active ? ' active' : ''}`;
            btn.disabled = disabled;
            btn.onclick = () => {
              currentPage = page;
              renderPage(true);
              renderPagination();
            };
            return btn;
          };

          paginationContainer.appendChild(
            createBtn('Prev', currentPage - 1, currentPage === 1)
          );

          for (let i = 1; i <= totalPages; i++) {
            paginationContainer.appendChild(
              createBtn(i, i, false, i === currentPage)
            );
          }

          paginationContainer.appendChild(
            createBtn('Next', currentPage + 1, currentPage === totalPages)
          );
        }

        // =============================
        // EVENT LISTENERS
        // =============================
        searchInput?.addEventListener('input', applyFilters);

        semesterSelectPop?.addEventListener('change', () => {
          currentSemester = semesterSelectPop.value;
          currentPage = 1;
          applyFilters();
        });

        sortSelectPop?.addEventListener('change', () => {
          currentSort = sortSelectPop.value;
          currentPage = 1;
          applyFilters();
        });

        typeSelectPop?.addEventListener('change', () => {
          currentType = typeSelectPop.value;

          // Sync desktop pills
          typeButtons.forEach(b =>
            b.classList.toggle('active', b.dataset.type === currentType)
          );

          currentPage = 1;
          applyFilters();
        });

        // Filter popover
        filtersToggle?.addEventListener('click', e => {
          e.stopPropagation();
          filtersPopover.style.display =
            filtersPopover.style.display === 'block' ? 'none' : 'block';
          filtersToggle.setAttribute(
            'aria-expanded',
            filtersPopover.style.display === 'block'
          );
        });

        document.addEventListener('click', e => {
          if (
            filtersPopover &&
            !filtersPopover.contains(e.target) &&
            e.target !== filtersToggle
          ) {
            filtersPopover.style.display = 'none';
            filtersToggle.setAttribute('aria-expanded', 'false');
          }
        });

        document.addEventListener('keydown', e => {
          if (e.key === 'Escape' && filtersPopover) {
            filtersPopover.style.display = 'none';
            filtersToggle.setAttribute('aria-expanded', 'false');
          }
        });

        // =============================
        // TYPE SCROLL BUTTONS
        // =============================
        scrollLeftBtn?.addEventListener('click', () => {
          typePillContainer.scrollBy({ left: -200, behavior: 'smooth' });
        });

        scrollRightBtn?.addEventListener('click', () => {
          typePillContainer.scrollBy({ left: 200, behavior: 'smooth' });
        });

        // =============================
        // RESIZE HANDLING
        // =============================
        window.addEventListener('resize', () => {
          PROJECTS_PER_PAGE = window.innerWidth < 768 ? 3 : 6;
          renderPage();
          renderPagination();
        });

        // =============================
        // INIT
        // =============================
        initTypePills();
        applyFilters();
      });
</script>
