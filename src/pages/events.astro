---
import "@/styles/global.css";
import "@/styles/about.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";
import eventsIndex from "@/data/events/index.js";

const semesters = eventsIndex?.semesters ?? [];

// Flatten events and attach semester id
const eventsBySemester = semesters
  .map(s => s.events.map(ev => ({ ...ev, semesterId: s.id })))
  .flat();

// Determine dynamic types
const preferred = ["Social", "Industry", "Projects", "Major"];
const allTypesSet = new Set();
eventsBySemester.forEach(ev => {
  const t = (ev.type ?? ev.category ?? "Other").toString();
  if (t) allTypesSet.add(t);
});
const preferredExisting = preferred.filter(p => allTypesSet.has(p));
const remaining = Array.from(allTypesSet).filter(t => !preferredExisting.includes(t));
remaining.sort((a, b) => a.localeCompare(b));
const types = ["All", ...preferredExisting, ...remaining];
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning."
    />
    <title>QUT AIML — Events</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <div class="content-wrapper about-space">
      <!-- HERO / TITLE -->
      <section class="pink-panel">
        <p class="pink-title">What's on at QUT AIML</p>
      </section>

      <!-- ROW BELOW HEADING: Search | Types (dynamic) | Filters button -->
      <section class="events-controls" style="margin: 1.25rem 0;">
        <div class="controls-row" style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
          <!-- Search (flex:1) -->
          <label style="flex:1;min-width:220px;">
            <input id="events-search" type="search" placeholder="Search events..." style="width:100%;padding:0.6rem;border-radius:6px;border:1px solid #ddd;" />
          </label>

          <!-- Dynamic type filters inline on the same row -->
          <div id="type-filters" style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
            {types.map((t, i) => (
              <button
                class={`type-btn ${t === "All" ? "active" : ""}`}
                data-type={t}
                type="button"
                style="padding:0.45rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;"
              >
                {t}
              </button>
            ))}
          </div>

          <!-- Filters button (popover contains Semester + Sort) -->
          <div style="margin-left:auto;position:relative;">
            <button id="filters-toggle" aria-haspopup="true" aria-expanded="false" type="button" style="display:flex;align-items:center;gap:0.5rem;padding:0.45rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">
              Filters
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden style="transform:translateY(1px);">
                <path d="M6 9l6 6 6-6" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>

            <!-- Popover -->
            <div id="filters-popover" role="dialog" aria-modal="false" style="position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.08);padding:0.75rem;display:none;z-index:40;">
              <div style="display:flex;flex-direction:column;gap:0.75rem;">
                <div style="display:flex;flex-direction:column;gap:0.25rem;">
                  <label for="semester-select-pop" style="font-size:0.85rem;color:#444;">Semester</label>
                  <select id="semester-select-pop" style="padding:0.45rem;border-radius:6px;border:1px solid #ddd;">
                    <option value="all" selected>All semesters</option>
                    {semesters.map(s => (
                      <option value={s.id}>{s.label}</option>
                    ))}
                  </select>
                </div>

                <div style="display:flex;flex-direction:column;gap:0.25rem;">
                  <label for="sort-select-pop" style="font-size:0.85rem;color:#444;">Sort</label>
                  <select id="sort-select-pop" style="padding:0.45rem;border-radius:6px;border:1px solid #ddd;">
                    <option value="date-desc" selected>Date descending</option>
                    <option value="date-asc">Date ascending</option>
                    <option value="title-asc">Title A–Z</option>
                  </select>
                </div>

                <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:0.25rem;">
                  <button id="filters-apply" type="button" style="padding:0.45rem 0.8rem;border-radius:6px;border:1px solid #1a73e8;background:#1a73e8;color:#fff;cursor:pointer;">Apply</button>
                  <button id="filters-cancel" type="button" style="padding:0.45rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EVENTS GRID -->
      <section id="events-grid" class="events-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.25rem;">
        {eventsBySemester.map((ev) => {
          const type = ev.type ?? ev.category ?? "Other";
          return (
            <article
              class="event-card"
              data-semester={ev.semesterId}
              data-category={ev.category}
              data-type={type}
              data-title={ev.title.toLowerCase()}
              data-date={ev.date}
              style="background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06);"
            >
              <a href={ev.url} style="display:block;color:inherit;text-decoration:none;">
                <div class="card-media" style="height:140px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;">
                  {ev.image ? <img src={ev.image} alt={ev.title} style="width:100%;height:100%;object-fit:cover;" /> : <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#999;">No image</div>}
                </div>

                <div class="card-body" style="padding:1rem;">
                  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
                    <h3 style="margin:0;font-size:1.05rem;">{ev.title}</h3>
                    <time style="font-size:0.85rem;color:#666;">{ev.dateLabel}</time>
                  </div>

                  <p style="margin:0.6rem 0 1rem;color:#444;font-size:0.95rem;line-height:1.35;">{ev.excerpt}</p>

                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.85rem;color:#888;">{type}</span>
                    <span style="font-weight:600;color:#1a73e8;">View more →</span>
                  </div>
                </div>
              </a>
            </article>
          );
        })}
      </section>
    </div>

    <Footer />

    <!-- Client-side script for filters and sorting (popover version) -->
    <script type="module">
      const searchInput = document.getElementById('events-search');
      const typeButtons = Array.from(document.querySelectorAll('.type-btn'));
      const grid = document.getElementById('events-grid');

      // Popover elements
      const filtersToggle = document.getElementById('filters-toggle');
      const filtersPopover = document.getElementById('filters-popover');
      const semesterSelectPop = document.getElementById('semester-select-pop');
      const sortSelectPop = document.getElementById('sort-select-pop');
      const filtersApply = document.getElementById('filters-apply');
      const filtersCancel = document.getElementById('filters-cancel');

      // Keep a single canonical sort and semester state (used by applyFilters)
      let currentSemester = 'all';
      let currentSort = 'date-desc';

      function getCards() {
        return Array.from(grid.querySelectorAll('.event-card'));
      }

      function applyFilters() {
        const query = searchInput.value.trim().toLowerCase();
        const activeTypeBtn = typeButtons.find(b => b.classList.contains('active'));
        const selectedType = activeTypeBtn ? activeTypeBtn.dataset.type : 'All';
        const selectedSemester = currentSemester; // 'all' or semester id

        getCards().forEach(card => {
          const title = card.dataset.title || '';
          const excerpt = card.querySelector('p')?.textContent.toLowerCase() || '';
          const cardType = card.dataset.type || '';
          const cardSemester = card.dataset.semester || '';
          const matchesQuery = !query || title.includes(query) || excerpt.includes(query);
          const matchesType = selectedType === 'All' || cardType === selectedType;
          const matchesSemester = selectedSemester === 'all' || cardSemester === selectedSemester;

          card.style.display = (matchesQuery && matchesType && matchesSemester) ? '' : 'none';
        });

        applySort();
      }

      function applySort() {
        const mode = currentSort;
        const visibleCards = getCards().filter(c => c.style.display !== 'none');

        visibleCards.sort((a, b) => {
          if (mode === 'title-asc') {
            return a.dataset.title.localeCompare(b.dataset.title);
          }
          if (mode === 'date-asc') {
            return new Date(a.dataset.date) - new Date(b.dataset.date);
          }
          // default date-desc
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        });

        visibleCards.forEach(c => grid.appendChild(c));
      }

      // Type buttons
      typeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          typeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          applyFilters();
        });
      });

      // Search input
      searchInput.addEventListener('input', () => applyFilters());

      // Popover toggle
      function openPopover() {
        filtersPopover.style.display = 'block';
        filtersToggle.setAttribute('aria-expanded', 'true');
        // set popover selects to current state
        semesterSelectPop.value = currentSemester;
        sortSelectPop.value = currentSort;
        // focus first control
        semesterSelectPop.focus();
        document.addEventListener('click', onDocClick);
        document.addEventListener('keydown', onKeyDown);
      }

      function closePopover() {
        filtersPopover.style.display = 'none';
        filtersToggle.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', onDocClick);
        document.removeEventListener('keydown', onKeyDown);
      }

      filtersToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = filtersPopover.style.display === 'block';
        if (open) closePopover(); else openPopover();
      });

      // Apply / Cancel inside popover
      filtersApply.addEventListener('click', () => {
        currentSemester = semesterSelectPop.value;
        currentSort = sortSelectPop.value;
        closePopover();
        applyFilters();
      });

      filtersCancel.addEventListener('click', () => {
        closePopover();
      });

      // Close when clicking outside
      function onDocClick(e) {
        if (!filtersPopover.contains(e.target) && e.target !== filtersToggle) {
          closePopover();
        }
      }

      // Close on Escape
      function onKeyDown(e) {
        if (e.key === 'Escape') closePopover();
      }

      // Initialize defaults
      currentSemester = 'all';
      currentSort = 'date-desc';
      applyFilters();
    </script>

    <style>
      .type-btn.active { background:#1a73e8; color:#fff; border-color:#1a73e8; }
      @media (max-width:520px) {
        #filters-popover { left: 8px; right: 8px; min-width: auto; }
      }
    </style>
  </body>
</html>
