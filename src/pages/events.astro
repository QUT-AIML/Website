---
import "@/styles/global.css";
import "@/styles/about.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";
import events from "@/data/events/index.js";

// Normalize to an array of overview objects so the template can rely on consistent fields.
// This handles three common shapes:
//  - index.js already returns overview objects
//  - index.js returns full event objects with `overview`
//  - index.js returns objects with `_raw.overview` (kept for compatibility)
const overviews = (events ?? []).map((ev) => {
  const o = ev.overview ?? ev._raw?.overview ?? ev;
  return {
    id: ev.id ?? o.id ?? (o.title ? o.title.toLowerCase().replace(/\s+/g, "-") : ""),
    title: o.title ?? "",
    date: o.date ?? "",
    dateLabel: o.dateLabel ?? o.date ?? "",
    category: o.category ?? "Other",
    excerpt: o.excerpt ?? "",
    image: o.image ?? "",
    url: o.url ?? `/events/${ev.id ?? o.id ?? ""}`,
  };
});
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning."
    />
    <title>QUT AIML — Events</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <div class="content-wrapper about-space">
      <!-- HERO / TITLE -->
      <section class="pink-panel">
        <p class="pink-title">What's on at QUT AIML</p>
      </section>

      <!-- SEARCH & FILTERS -->
      <section class="events-controls" style="margin: 2rem 0;">
        <div class="controls-row" style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
          <label style="flex:1;min-width:220px;">
            <input id="events-search" type="search" placeholder="Search events..." style="width:100%;padding:0.6rem;border-radius:6px;border:1px solid #ddd;" />
          </label>

          <div id="category-filters" style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="filter-btn active" data-category="All" type="button" style="padding:0.5rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">All</button>
            <button class="filter-btn" data-category="Hackathons" type="button" style="padding:0.5rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">Hackathons</button>
            <button class="filter-btn" data-category="Games" type="button" style="padding:0.5rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">Games</button>
            <button class="filter-btn" data-category="Meetings" type="button" style="padding:0.5rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">Meetings</button>
            <button class="filter-btn" data-category="Projects" type="button" style="padding:0.5rem 0.8rem;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">Projects</button>
          </div>

          <div style="margin-left:auto;">
            <label for="sort-select" style="font-size:0.9rem;color:#666;margin-right:0.5rem;">Sort</label>
            <select id="sort-select" style="padding:0.4rem;border-radius:6px;border:1px solid #ddd;">
              <option value="date-asc">Date ascending</option>
              <option value="date-desc" selected>Date descending</option>
              <option value="title-asc">Title A–Z</option>
            </select>
          </div>
        </div>
      </section>

      <!-- EVENTS GRID -->
      <section id="events-grid" class="events-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.25rem;">
        {overviews.map((ev) => (
          <article class="event-card" data-category={ev.category} data-title={ev.title.toLowerCase()} data-date={ev.date} style="background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
            <a href={ev.url} style="display:block;color:inherit;text-decoration:none;">
              <div class="card-media" style="height:140px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;">
                {ev.image ? <img src={ev.image} alt={ev.title} style="width:100%;height:100%;object-fit:cover;" /> : <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#999;">No image</div>}
              </div>

              <div class="card-body" style="padding:1rem;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
                  <h3 style="margin:0;font-size:1.05rem;">{ev.title}</h3>
                  <time style="font-size:0.85rem;color:#666;">{ev.dateLabel}</time>
                </div>

                <p style="margin:0.6rem 0 1rem;color:#444;font-size:0.95rem;line-height:1.35;">{ev.excerpt}</p>

                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <span style="font-size:0.85rem;color:#888;">{ev.category}</span>
                  <span style="font-weight:600;color:#1a73e8;">View more →</span>
                </div>
              </div>
            </a>
          </article>
        ))}
      </section>
    </div>

    <Footer />

    <!-- Client-side script for search, filter, sort -->
    <script type="module">
      const searchInput = document.getElementById('events-search');
      const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
      const sortSelect = document.getElementById('sort-select');
      const grid = document.getElementById('events-grid');

      // Helper to get current list of cards (re-query in case DOM changes)
      function getCards() {
        return Array.from(grid.querySelectorAll('.event-card'));
      }

      function applyFilters() {
        const cards = getCards();
        const query = searchInput.value.trim().toLowerCase();
        const activeCategoryBtn = filterButtons.find(b => b.classList.contains('active'));
        const category = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'All';

        cards.forEach(card => {
          const title = card.dataset.title || '';
          const cardCategory = card.dataset.category || '';
          const matchesQuery = !query || title.includes(query) || card.querySelector('p')?.textContent.toLowerCase().includes(query);
          const matchesCategory = category === 'All' || cardCategory === category;

          card.style.display = (matchesQuery && matchesCategory) ? '' : 'none';
        });

        applySort(); // keep sort consistent after filtering
      }

      function applySort() {
        const mode = sortSelect.value;
        const cards = getCards();
        const visibleCards = cards.filter(c => c.style.display !== 'none');

        visibleCards.sort((a, b) => {
          if (mode === 'title-asc') {
            return a.dataset.title.localeCompare(b.dataset.title);
          }
          if (mode === 'date-asc') {
            return new Date(a.dataset.date) - new Date(b.dataset.date);
          }
          // default date-desc
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        });

        // Re-append in sorted order
        visibleCards.forEach(c => grid.appendChild(c));
      }

      // Wire up events
      searchInput.addEventListener('input', () => applyFilters());
      sortSelect.addEventListener('change', () => applySort());

      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          applyFilters();
        });
      });

      // Initial sort
      applySort();
    </script>
  </body>
</html>
