---
import "@/styles/global.css";
import "@/styles/events/events.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";
import eventsIndex from "@/data/events/index.js";

const semesters = eventsIndex?.semesters ?? [];

// Flatten events and attach semester id
const eventsBySemester = semesters
  .map(s => s.events.map(ev => ({ ...ev, semesterId: s.id })))
  .flat();

// Determine dynamic types
const preferred = ["Social", "Industry", "Projects", "Major"];
const allTypesSet = new Set();
eventsBySemester.forEach(ev => {
  const t = (ev.type ?? ev.category ?? "Other").toString();
  if (t) allTypesSet.add(t);
});
const preferredExisting = preferred.filter(p => allTypesSet.has(p));
const remaining = Array.from(allTypesSet).filter(t => !preferredExisting.includes(t));
remaining.sort((a, b) => a.localeCompare(b));
const types = ["All", ...preferredExisting, ...remaining];

const today = new Date();
today.setHours(0, 0, 0, 0); // normalize

const featuredEvents = eventsBySemester
  .filter(ev => ev.featured)
  .filter(ev => {
    const eventDate = new Date(ev.date);
    eventDate.setHours(0, 0, 0, 0);
    return eventDate >= today;
  });

// --- Determine latest semester by label (Sem X, YYYY)
function parseSemesterLabel(label) {
  const [semPart, yearPart] = label.split(',').map(s => s.trim());
  const semNum = parseInt(semPart.replace('Sem ', ''), 10);
  const yearNum = parseInt(yearPart, 10);
  return { semNum, yearNum };
}

const latestSemester = semesters.reduce((latest, s) => {
  if (!latest) return s;
  const { semNum: semA, yearNum: yearA } = parseSemesterLabel(latest.label);
  const { semNum: semB, yearNum: yearB } = parseSemesterLabel(s.label);

  if (yearB > yearA) return s;
  if (yearB === yearA && semB > semA) return s;
  return latest;
}, null);

---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning."
    />
    <title>QUT AIML</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <div class="content-wrapper events-space">
      
      {featuredEvents.length > 0 && (
        <>
          <section class="pink-panel">
            <p class="pink-title">Featured Events</p>
          </section>

          <section class="featured-events-panel">
            <div class="featured-events-grid">
              {featuredEvents.map(ev => (
                <article class="event-card" data-semester={ev.semesterId} data-category={ev.category} data-type={ev.type ?? ev.category ?? "Other"} data-title={ev.title.toLowerCase()} data-date={ev.date}>
                  <a href={ev.url}>
                    <div class="card-media">
                      {ev.image ? (
                        <img src={ev.image} alt={ev.title} />
                      ) : (
                        <div class="no-image">No image</div>
                      )}
                    </div>
                    <div class="card-body">
                      <h3 class="card-title">{ev.title}</h3>
                      <div class="card-divider"></div>
                      <time class="card-date">{ev.dateLabel}</time>
                      <p class="card-description">{ev.excerpt}</p>
                      <div class="card-footer">
                        <span class="card-view-more">View more →</span>
                      </div>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </section>
        </>
      )}

      <section class="pink-panel">
        <p class="pink-title">What's on at QUT AIML</p>
      </section>

      <div class="key-content">
        <section class="events-controls">
          <div class="controls-row">
            <div class="search-wrapper">
              <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="7" />
                <line x1="16.65" y1="16.65" x2="21" y2="21" />
              </svg>
              <input
                id="events-search"
                type="search"
                placeholder="Search"
                aria-label="Search events"
              />
            </div>

            <div class="type-filter-wrapper">
              <span class="type-filter-label">Sort by:</span>
              <div id="type-filters" class="type-filter-pill">
                {types.map((t) => (
                  <button
                    class={`type-btn ${t === "All" ? "active" : ""}`}
                    data-type={t}
                    type="button"
                  >
                    {t}
                  </button>
                ))}
              </div>
            </div>

            <div style="margin-left:auto; position:relative;">
              <button id="filters-toggle" aria-haspopup="true" aria-expanded="false" type="button" class="filters-toggle-btn">
                <svg class="filters-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z"/>
                </svg>
              </button>

              <div id="filters-popover" role="dialog" aria-modal="false" class="filters-popover">
                <div class="filters-popover-content">
                  <div class="filter-group">
                    <label for="semester-select-pop">Semester</label>
                    <select id="semester-select-pop">
                      <option value="all" selected>All semesters</option>
                      {semesters.filter(s => s.id !== latestSemester.id).map(s => (
                        <option value={s.id}>{s.label}</option>
                      ))}
                    </select>
                  </div>

                  <div class="filter-group">
                    <label for="sort-select-pop">Sort</label>
                    <select id="sort-select-pop">
                      <option value="upcoming" selected>Upcoming events</option>
                      <option value="past">Past events</option>
                      <option value="title-asc">Title A–Z</option>
                    </select>
                  </div>

                  <div class="filter-actions">
                    <button id="filters-apply" type="button" class="btn-secondary">
                      Apply
                    </button>
                    <button id="filters-cancel" type="button" class="btn-secondary">
                      Cancel
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <section class="events-panel">
          <section id="events-grid" class="events-grid">
            {eventsBySemester.map((ev) => {
              const type = ev.type ?? ev.category ?? "Other";
              return (
                <article
                  class="event-card"
                  data-semester={ev.semesterId}
                  data-category={ev.category}
                  data-type={type}
                  data-title={ev.title.toLowerCase()}
                  data-date={ev.date}
                >
                  <a href={ev.url}>
                    <div class="card-media">
                      {ev.image ? (
                        <img src={ev.image} alt={ev.title} />
                      ) : (
                        <div class="no-image">No image</div>
                      )}
                    </div>

                    <div class="card-body">
                      <h3 class="card-title">{ev.title}</h3>
                      <div class="card-divider"></div>
                      <time class="card-date">{ev.dateLabel}</time>
                      <p class="card-description">{ev.excerpt}</p>
                      <div class="card-footer">
                        <span class="card-view-more">View more →</span>
                      </div>
                    </div>
                  </a>
                </article>
              );
            })}
          </section>
        </section>

          <!-- Pagination container -->
        <div id="events-pagination"></div>

      </div>
    </div>

    <Footer />
  </body>
  </html>

    
    

<script type="module">
  
      const searchInput = document.getElementById('events-search');
      const grid = document.getElementById('events-grid');
      const filtersToggle = document.getElementById('filters-toggle');
      const filtersPopover = document.getElementById('filters-popover');
      const semesterSelectPop = document.getElementById('semester-select-pop');
      const sortSelectPop = document.getElementById('sort-select-pop');
      const filtersApply = document.getElementById('filters-apply');
      const filtersCancel = document.getElementById('filters-cancel');
      const EVENTS_PER_PAGE = 6;
      let currentPage = 1;
      let currentSemester = 'all';
      let currentSort = 'upcoming';
      let filteredCards = [];
      let typeButtons = [];

      const getCards = () => Array.from(grid.querySelectorAll('.event-card'));

      function renderTypeButtons(types){
        const container = document.getElementById('type-filters');
        container.innerHTML = '';
        types.forEach(t => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.type = t;
          btn.textContent = t;
          btn.className = `type-btn ${t==='All'?'active':''}`;
          btn.addEventListener('click', () => { typeButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); applyFilters(); });
          container.appendChild(btn);
        });
        typeButtons = Array.from(container.querySelectorAll('.type-btn'));
      }

      function applyFilters(){
        const query = searchInput.value.trim().toLowerCase();
        const activeTypeBtn = typeButtons.find(b => b.classList.contains('active'));
        const selectedType = activeTypeBtn?.dataset.type ?? 'All';
        const today = new Date(); today.setHours(0,0,0,0);

        filteredCards = getCards().filter(card => {
          const title = card.dataset.title || '';
          const excerpt = card.querySelector('p')?.textContent.toLowerCase() || '';
          const cardType = card.dataset.type || '';
          const cardSemester = card.dataset.semester || '';
          const cardDate = new Date(card.dataset.date); cardDate.setHours(0,0,0,0);

          const matchesQuery = !query || title.includes(query) || excerpt.includes(query);
          const matchesType = selectedType==='All' || cardType===selectedType;
          const matchesSemester = currentSemester==='all' || cardSemester===currentSemester;
          const matchesSort = currentSort==='upcoming' ? cardDate>=today : currentSort==='past' ? cardDate<today : true;

          return matchesQuery && matchesType && matchesSemester && matchesSort;
        });

        currentPage = 1;
        applySort();
        renderPage();
        renderPagination();

        // Update types dynamically
        const typeSet = new Set(filteredCards.map(c=>c.dataset.type||'Other'));
        const preferred = ["Social","Industry","Projects","Major"];
        const preferredExisting = preferred.filter(p=>typeSet.has(p));
        const remaining = Array.from(typeSet).filter(t=>!preferredExisting.includes(t)).sort((a,b)=>a.localeCompare(b));
        renderTypeButtons(remaining.length>0?['All',...preferredExisting,...remaining]:['All']);
      }

      function applySort(){
        const today = new Date(); today.setHours(0,0,0,0);
        filteredCards.sort((a,b) => {
          const dateA = new Date(a.dataset.date); dateA.setHours(0,0,0,0);
          const dateB = new Date(b.dataset.date); dateB.setHours(0,0,0,0);
          if(currentSort==='title-asc') return a.dataset.title.localeCompare(b.dataset.title);
          if(currentSort==='upcoming') return dateA-dateB;
          if(currentSort==='past') return dateB-dateA;
          return 0;
        });
      }

      function renderPage(){
        const start = (currentPage-1)*EVENTS_PER_PAGE;
        const end = start+EVENTS_PER_PAGE;
        getCards().forEach(c=>c.style.display='none');
        filteredCards.slice(start,end).forEach(c=>c.style.display='');
      }

      function renderPagination(){
        const container = document.getElementById('events-pagination');
        const totalPages = Math.ceil(filteredCards.length/EVENTS_PER_PAGE);
        if(totalPages<=1){ container.innerHTML=''; return; }
        let html = `<button data-page="${currentPage-1}" ${currentPage===1?'disabled':''}>Prev</button>`;
        for(let i=1;i<=totalPages;i++){ html+=`<button data-page="${i}" style="${i===currentPage?'background:#1a73e8;color:#fff;':''}">${i}</button>`; }
        html += `<button data-page="${currentPage+1}" ${currentPage===totalPages?'disabled':''}>Next</button>`;
        container.innerHTML=html;
        Array.from(container.querySelectorAll('button')).forEach(btn=>{
          btn.addEventListener('click',()=>{ 
            let page=parseInt(btn.dataset.page); 
            if(page<1) page=1; if(page>totalPages) page=totalPages; 
            currentPage=page; renderPage(); renderPagination(); 
          });
        });
      }

      searchInput.addEventListener('input', applyFilters);
      filtersApply.addEventListener('click', () => {
        currentSemester = semesterSelectPop.value;
        currentSort = sortSelectPop.value;
        applyFilters();
        filtersPopover.style.display='none';
      });
      filtersCancel.addEventListener('click', ()=>{ filtersPopover.style.display='none'; });
      filtersToggle.addEventListener('click', ()=>{ filtersPopover.style.display=filtersPopover.style.display==='block'?'none':'block'; });

      applyFilters();
    </script>