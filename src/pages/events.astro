---
import "@/styles/global.css";
import "@/styles/events/events.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";
import eventsIndex from "@/data/events/index.js";

const semesters = eventsIndex?.semesters ?? [];

// Flatten events and attach semester id
const eventsBySemester = semesters
  .map(s => s.events.map(ev => ({ ...ev, semesterId: s.id })))
  .flat();

// Determine dynamic types
const preferred = ["Social", "Industry", "Projects", "Major"];
const allTypesSet = new Set();
eventsBySemester.forEach(ev => {
  const t = (ev.type ?? ev.category ?? "Other").toString();
  if (t) allTypesSet.add(t);
});
const preferredExisting = preferred.filter(p => allTypesSet.has(p));
const remaining = Array.from(allTypesSet).filter(t => !preferredExisting.includes(t));
remaining.sort((a, b) => a.localeCompare(b));
const types = ["All", ...preferredExisting, ...remaining];

const today = new Date();
today.setHours(0, 0, 0, 0); // normalize to start of the day

const featuredEvents = eventsBySemester
  .filter(ev => ev.featured)
  .filter(ev => {
    const eventDate = new Date(ev.date);
    eventDate.setHours(0, 0, 0, 0); // normalize to start of the day
    return eventDate >= today;
  });
  
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning."
    />
    <title>QUT AIML</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <div class="content-wrapper events-space">
      
      {featuredEvents.length > 0 && (
        <>
          <section class="pink-panel">
            <p class="pink-title">Featured Events</p>
          </section>

          <section class="featured-events-panel">
            <div class="featured-events-grid">
              {featuredEvents.map(ev => (
                <article class="event-card" data-semester={ev.semesterId} data-category={ev.category} data-type={ev.type ?? ev.category ?? "Other"} data-title={ev.title.toLowerCase()} data-date={ev.date}>
                  <a href={ev.url}>
                    <div class="card-media">
                      {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                    </div>
                    <div class="card-body">
                      <h3 class="card-title">{ev.title}</h3>
                      <div class="card-divider"></div>
                      <time class="card-date">{ev.dateLabel}</time>
                      <p class="card-description">{ev.excerpt}</p>
                      <div class="card-footer">
                        <span class="card-view-more">View more →</span>
                      </div>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </section>
        </>
      )}

      <section class="pink-panel">
        <p class="pink-title">What's on at QUT AIML</p>
      </section>

      <div class="key-content">
        <section class="events-controls">
          <div class="controls-row">

            <div class="search-filter-wrapper">
              <!-- Search bar -->
              <div class="search-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="11" cy="11" r="7" />
                  <line x1="16.65" y1="16.65" x2="21" y2="21" />
                </svg>
                <input
                  id="events-search"
                  type="search"
                  placeholder="Search"
                  aria-label="Search events"
                />
              </div>

              <!-- Desktop type pills -->
              <span class="type-filter-label">Sort by:</span>
              <div id="type-filters" class="type-filter-pill">
                {types.map((t) => (
                  <button
                    class={`type-btn ${t === "All" ? "active" : ""}`}
                    data-type={t}
                    type="button"
                  >
                    {t}
                  </button>
                ))}
              </div>

              <!-- Filter dropdown button -->
              <div class="filters-wrapper">
                <button id="filters-toggle" aria-haspopup="true" aria-expanded="false" type="button" class="filters-toggle-btn">
                  <svg class="filters-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z"/>
                  </svg>
                </button>

                <div id="filters-popover" role="dialog" aria-modal="false" class="filters-popover">
                  <div class="filters-popover-content">
                    <div class="filter-group">
                      <label for="semester-select-pop">Semester</label>
                      <select id="semester-select-pop">
                        <option value="all" selected>All semesters</option>
                        {semesters.map(s => (
                          <option value={s.id}>{s.label}</option>
                        ))}
                      </select>
                    </div>

                    <!-- THIS WILL BE VISIBLE ONLY ON MOBILE -->
                    <div class="filter-group hidden-type">
                      <label for="type-select-pop">Type</label>
                      <select id="type-select-pop">
                        {types.map(t => (
                          <option value={t}>{t}</option>
                        ))}
                      </select>
                    </div>

                    <div class="filter-group">
                      <label for="sort-select-pop">Sort</label>
                      <select id="sort-select-pop">
                        <option value="upcoming" selected>Upcoming events</option>
                        <option value="past">Past events</option>
                        <option value="title-asc">Title A–Z</option>
                      </select>
                    </div>

                    <div class="filter-actions">
                      <button id="filters-apply" type="button" class="btn-secondary">
                        Apply
                      </button>
                      <button id="filters-cancel" type="button" class="btn-secondary">
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </section>

        <section class="events-panel">
          <section id="events-grid" class="events-grid">
            {eventsBySemester.map((ev) => {
              const type = ev.type ?? ev.category ?? "Other";
              return (
                <article
                  class="event-card"
                  data-semester={ev.semesterId}
                  data-category={ev.category}
                  data-type={type}
                  data-title={ev.title.toLowerCase()}
                  data-date={ev.date}
                >
                  <a href={ev.url}>
                    <div class="card-media">
                      {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                    </div>
                    <div class="card-body">
                      <h3 class="card-title">{ev.title}</h3>
                      <div class="card-divider"></div>
                      <time class="card-date">{ev.dateLabel}</time>
                      <p class="card-description">{ev.excerpt}</p>
                      <div class="card-footer">
                        <span class="card-view-more">View more →</span>
                      </div>
                    </div>
                  </a>
                </article>
              );
            })}
          </section>
        </section>

          <!-- Pagination container -->
        <div id="events-pagination"></div>

      </div>
    </div>

    <Footer />
  </body>
  </html>

    
    

  
  <script type="module">
    const searchInput = document.getElementById('events-search');
    const grid = document.getElementById('events-grid');
    let paginationContainer = document.getElementById('events-pagination');

    if (!paginationContainer) {
      paginationContainer = document.createElement('div');
      paginationContainer.id = 'events-pagination';
      paginationContainer.style.textAlign = 'center';
      paginationContainer.style.marginTop = '2rem';
      grid.parentNode.appendChild(paginationContainer);
    }

    const filtersToggle = document.getElementById('filters-toggle');
    const filtersPopover = document.getElementById('filters-popover');
    const semesterSelectPop = document.getElementById('semester-select-pop');
    const sortSelectPop = document.getElementById('sort-select-pop');
    const filtersApply = document.getElementById('filters-apply');
    const filtersCancel = document.getElementById('filters-cancel');

    // New: mobile type select
    const typeSelectPop = document.getElementById('type-select-pop');

    const EVENTS_PER_PAGE = 6;
    let currentPage = 1;
    let currentSemester = 'all';
    let currentSort = 'upcoming';
    let filteredCards = [];
    let typeButtons = [];

    function getCards() {
      return Array.from(grid.querySelectorAll('.event-card'));
    }

    // Generate types based on filtered cards
    function getTypesForFilteredCards() {
      const query = searchInput.value.trim().toLowerCase();
      const today = new Date(); today.setHours(0,0,0,0);

      const cards = getCards().filter(card => {
        const cardSemester = card.dataset.semester || '';
        const title = card.dataset.title || '';
        const excerpt = card.querySelector('p')?.textContent.toLowerCase() || '';
        const cardDate = new Date(card.dataset.date); cardDate.setHours(0,0,0,0);

        const matchesSemester = currentSemester === 'all' || cardSemester === currentSemester;
        let matchesSort = true;
        if (currentSort === 'upcoming') matchesSort = cardDate >= today;
        if (currentSort === 'past') matchesSort = cardDate < today;
        const matchesQuery = !query || title.includes(query) || excerpt.includes(query);

        return matchesSemester && matchesSort && matchesQuery;
      });

      const typeSet = new Set();
      cards.forEach(card => typeSet.add(card.dataset.type || 'Other'));

      const preferred = ["Social", "Industry", "Projects", "Major"];
      const preferredExisting = preferred.filter(p => typeSet.has(p));
      const remaining = Array.from(typeSet).filter(t => !preferredExisting.includes(t)).sort((a,b) => a.localeCompare(b));
      const allTypes = [...preferredExisting, ...remaining];

      if (allTypes.length <= 1) return ['All'];
      return ['All', ...preferredExisting, ...remaining];
    }

    // Render desktop type pills
    function renderTypeButtons(types) {
      const container = document.getElementById('type-filters');
      container.innerHTML = '';

      types.forEach(t => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.type = t;
        btn.textContent = t;
        btn.className = `type-btn ${t === 'All' ? 'active' : ''}`;
        btn.addEventListener('click', () => {
          typeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          applyFilters();
        });
        container.appendChild(btn);
      });

      typeButtons.length = 0;
      typeButtons.push(...Array.from(container.querySelectorAll('.type-btn')));
    }

    // Apply filters (search, type, semester, sort)
    function applyFilters() {
      const query = searchInput.value.trim().toLowerCase();

      // Determine type filter
      let selectedType = 'All';
      if (window.innerWidth <= 768 && typeSelectPop) {
        selectedType = typeSelectPop.value;
      } else {
        const activeTypeBtn = typeButtons.find(b => b.classList.contains('active'));
        selectedType = activeTypeBtn ? activeTypeBtn.dataset.type : 'All';
      }

      const today = new Date(); today.setHours(0,0,0,0);

      filteredCards = getCards().filter(card => {
        const title = card.dataset.title || '';
        const excerpt = card.querySelector('p')?.textContent.toLowerCase() || '';
        const cardType = card.dataset.type || '';
        const cardSemester = card.dataset.semester || '';
        const cardDate = new Date(card.dataset.date); cardDate.setHours(0,0,0,0);

        const matchesQuery = !query || title.includes(query) || excerpt.includes(query);
        const matchesType = selectedType === 'All' || cardType === selectedType;
        const matchesSemester = currentSemester === 'all' || cardSemester === currentSemester;

        let matchesSort = true;
        if (currentSort === 'upcoming') matchesSort = cardDate >= today;
        if (currentSort === 'past') matchesSort = cardDate < today;

        return matchesQuery && matchesType && matchesSemester && matchesSort;
      });

      currentPage = 1;
      applySort();
      renderPage();
      renderPagination();

      let noEventsMessage = document.getElementById('no-events-message');
      if (!noEventsMessage) {
        noEventsMessage = document.createElement('div');
        noEventsMessage.id = 'no-events-message';
        noEventsMessage.textContent = 'No events found';
        noEventsMessage.style.textAlign = 'center';
        noEventsMessage.style.padding = '2rem';
        noEventsMessage.style.gridColumn = '1 / -1';
        grid.appendChild(noEventsMessage);
      }
      noEventsMessage.style.display = filteredCards.length === 0 ? 'block' : 'none';

      // Update type buttons on desktop only
      if (window.innerWidth > 768) {
        const newTypes = getTypesForFilteredCards();
        renderTypeButtons(newTypes);
      }
    }

    // Apply sorting
    function applySort() {
      const today = new Date(); today.setHours(0,0,0,0);
      filteredCards.sort((a, b) => {
        const dateA = new Date(a.dataset.date); dateA.setHours(0,0,0,0);
        const dateB = new Date(b.dataset.date); dateB.setHours(0,0,0,0);

        if (currentSort === 'title-asc') return a.dataset.title.localeCompare(b.dataset.title);
        if (currentSort === 'upcoming') return dateA - dateB;
        if (currentSort === 'past') return dateB - dateA;
        return 0;
      });
    }

    // Render current page
    function renderPage() {
      const start = (currentPage - 1) * EVENTS_PER_PAGE;
      const end = start + EVENTS_PER_PAGE;

      getCards().forEach(card => card.style.display = 'none');
      filteredCards.slice(start, end).forEach(card => card.style.display = '');
    }

    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(filteredCards.length / EVENTS_PER_PAGE);
      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }

      const isMobile = window.innerWidth < 768;
      let html = `<button class="pagination-btn" data-page="${currentPage-1}" ${currentPage===1?'disabled':''}>Prev</button>`;

      if (isMobile) {
        // Mobile: show current page and previous page if exists, plus next page if exists
        const pagesToShow = [];
        
        if (currentPage > 1) pagesToShow.push(currentPage - 1);
        pagesToShow.push(currentPage);
        if (currentPage < totalPages) pagesToShow.push(currentPage + 1);

        // Ensure only max 2 numbers shown: prefer current and previous if possible
        if (pagesToShow.length > 2) pagesToShow.shift(); // remove oldest to keep max 2

        pagesToShow.forEach(p => {
          html += `<button class="pagination-btn${p === currentPage ? ' active' : ''}" data-page="${p}">${p}</button>`;
        });

      } else {
        // Desktop: show all pages
        for (let i = 1; i <= totalPages; i++) {
          html += `<button class="pagination-btn${i === currentPage ? ' active' : ''}" data-page="${i}">${i}</button>`;
        }
      }

      html += `<button class="pagination-btn" data-page="${currentPage+1}" ${currentPage===totalPages?'disabled':''}>Next</button>`;

      paginationContainer.innerHTML = html;

      // Re-attach click listeners
      Array.from(paginationContainer.querySelectorAll('.pagination-btn')).forEach(btn => {
        btn.addEventListener('click', () => {
          let page = parseInt(btn.dataset.page);
          if (page < 1) page = 1;
          if (page > totalPages) page = totalPages;
          currentPage = page;
          renderPage();
          renderPagination();
        });
      });
    }



    // Event listeners
    searchInput.addEventListener('input', applyFilters);

    // Filters popover
    filtersToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      if (filtersPopover.style.display === 'block') closePopover();
      else openPopover();
    });

    filtersApply.addEventListener('click', () => {
      currentSemester = semesterSelectPop.value;
      currentSort = sortSelectPop.value;
      closePopover();
      applyFilters();
    });

    filtersCancel.addEventListener('click', closePopover);

    function openPopover() {
      filtersPopover.style.display = 'block';
      filtersToggle.setAttribute('aria-expanded', 'true');
      semesterSelectPop.value = currentSemester;
      sortSelectPop.value = currentSort;
      if (typeSelectPop && window.innerWidth <= 768) {
        typeSelectPop.value = typeButtons.find(b => b.classList.contains('active'))?.dataset.type || 'All';
      }
      semesterSelectPop.focus();
      document.addEventListener('click', onDocClick);
      document.addEventListener('keydown', onKeyDown);
    }

    function closePopover() {
      filtersPopover.style.display = 'none';
      filtersToggle.setAttribute('aria-expanded', 'false');
      document.removeEventListener('click', onDocClick);
      document.removeEventListener('keydown', onKeyDown);
    }

    function onDocClick(e) {
      if (!filtersPopover.contains(e.target) && e.target !== filtersToggle) closePopover();
    }

    function onKeyDown(e) {
      if (e.key === 'Escape') closePopover();
    }

    // Initialize
    applyFilters();

    // Optional: re-apply filters on window resize to switch between mobile/desktop type filter
    window.addEventListener('resize', applyFilters);

</script>
