---
import "@/styles/global.css";
import "@/styles/events/event-details.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";

// ----------------------------------------------------
// Helper: slugify title to match URL (must be defined
// BEFORE getStaticPaths and inside the frontmatter)
// ----------------------------------------------------
function slugify(title: string) {
  return title
    .toLowerCase()
    .replace(/[^\w\s-]/g, "")
    .replace(/\s+/g, "-");
}

// ----------------------------------------------------
// Step 0: Export static paths for all events
// ----------------------------------------------------
export async function getStaticPaths() {
  const rawEventFiles = import.meta.glob('/public/data/events/*/*.json', { eager: true });
  const paths = [];

  for (const [path, mod] of Object.entries(rawEventFiles)) {
    const segments = path.split('/');
    const semesterId = segments.at(-2);
    const data = mod.default;
    const events = Array.isArray(data) ? data : [data];

    events.forEach(ev => {
      const slug = ev.title
        .toLowerCase()
        .replace(/[^\w\s-]/g, "")
        .replace(/\s+/g, "-");

      paths.push({
        params: {
          semester: semesterId,
          event: slug,
        },
      });
    });
  }

  return paths;
}

// ----------------------------------------------------
// Step 1: Get route params
// ----------------------------------------------------
const { params } = Astro;
const semester = params.semester;
const eventSlug = params.event;

// ----------------------------------------------------
// Step 2: Load all events (build-time)
const rawEventFiles = import.meta.glob('/public/data/events/*/*.json', { eager: true });
const allEvents = [];

for (const [path, mod] of Object.entries(rawEventFiles)) {
  const segments = path.split('/');
  const semesterId = segments.at(-2);
  const data = mod.default;
  const events = Array.isArray(data) ? data : [data];

  events.forEach(ev => {
    allEvents.push({
      ...ev,
      semesterId,
      slug: slugify(ev.title),
      image: ev.image ? `/data/events/${semesterId}/images/${ev.image}` : null,
      gallery: ev.gallery?.map(g => ({
        ...g,
        src: g.src ? `/data/events/${semesterId}/images/${g.src}` : null,
      })) ?? [],
    });
  });
}

// ----------------------------------------------------
// Step 3: Find the requested event
// ----------------------------------------------------
const eventData = allEvents.find(ev => ev.semesterId === semester && ev.slug === eventSlug);

const notFound = !eventData;
const overview = eventData ?? null;
const details = eventData ?? {};
const pageTitle = eventData
  ? `${details.title} — QUT AIML`
  : "Event not found";
---



<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content={overview ? overview.excerpt ?? details.description : "Event not found"} />
    <title>{pageTitle}</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <main class="unique-event-space">
      {notFound ? (
        <section class="unique-event-card unique-event-notfound">
          <h1>Event not found</h1>
          <p>No event exists with ID <strong>{eventSlug}</strong> in semester <strong>{semester}</strong>.</p>
          <a href="/events" class="unique-link">← Back to events</a>
        </section>
      ) : (
        <article class="unique-event-card">
          <nav class="event-back">
            <a href="/events" class="unique-link">← Back to events</a>
          </nav>

          <h1 class="event-title">{details.title}</h1>

          <div class="event-meta-pills">
            {details.dateLabel && <span class="meta-pill">{details.dateLabel}</span>}
            {details.time && <span class="meta-pill">{details.time}</span>}
            {details.location && <span class="meta-pill">{details.location}</span>}
          </div>

          <div class="event-divider"></div>

          <section class="event-description">
            <p>{details.description ?? details.excerpt}</p>
          </section>

          {details.image && (
            <section class="event-image">
              <img src={details.image} alt={details.title} />
            </section>
          )}

          {details.registration && (
            <section class="event-registration">
              <h3>Registration</h3>
              <p>{details.registration.required ? "Registration required" : "No registration required"}</p>
              {details.registration.link && (
                <a href={details.registration.link} class="register-button">Register now</a>
              )}
              {details.registration.price && <p class="event-price">{details.registration.price}</p>}
            </section>
          )}

          {details.schedule && details.schedule.length > 0 && (
            <section class="unique-section">
              <h3 class="unique-section-title">Schedule</h3>
              <ul>
                {details.schedule.map(item => (
                  <li>{item.time && <strong>{item.time} — </strong>}{item.activity}</li>
                ))}
              </ul>
            </section>
          )}

          {details.speakers && details.speakers.length > 0 && (
            <section class="unique-section">
              <h3 class="unique-section-title">Speakers</h3>
              <ul>
                {details.speakers.map(s => (
                  <li>{s.name}{s.role && ` — ${s.role}`}</li>
                ))}
              </ul>
            </section>
          )}

          {details.gallery && details.gallery.length > 0 && (
            <section class="unique-section">
              <h3 class="unique-section-title">Gallery</h3>
              <div class="unique-gallery">
                {details.gallery.map((g, i) => (
                  <div class="unique-gallery-item">
                    <img
                      src={g.src}
                      alt={g.alt ?? details.title}
                      class="unique-gallery-image"
                      id={`galleryImg-${i}`}
                    />
                  </div>
                ))}
              </div>

              {/* Modals */}
              {details.gallery.map((g, i) => (
                <div id={`galleryModal-${i}`} class="modal">
                  <span class="modal-close" id={`galleryClose-${i}`}>&times;</span>
                  <img class="modal-content" id={`galleryModalImg-${i}`} />
                </div>
              ))}
            </section>
          )}

          {details.contact && (
            <footer class="unique-footer">
              <strong>Contact</strong>
              {details.contact.email && (
                <div>Email: <a href={`mailto:${details.contact.email}`} class="unique-link">{details.contact.email}</a></div>
              )}
              {details.contact.phone && <div>Phone: {details.contact.phone}</div>}
            </footer>
          )}
        </article>
      )}
    </main>

    <Footer />
  </body>
</html>


<script>
  // Gallery modals
  document.querySelectorAll('.unique-gallery-image').forEach((img, i) => {
    const modal = document.getElementById(`galleryModal-${i}`);
    const modalImg = document.getElementById(`galleryModalImg-${i}`);
    const closeBtn = document.getElementById(`galleryClose-${i}`);

    img.onclick = () => {
      modal.style.display = "block";
      modalImg.src = img.src;
      document.body.classList.add("modal-open");
    };

    closeBtn.onclick = () => {
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
    };

    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
        document.body.classList.remove("modal-open");
      }
    };
  });
</script>
