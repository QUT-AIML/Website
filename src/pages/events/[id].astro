---
import "@/styles/global.css";
import "@/styles/events/event-details.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";

// Required for dynamic routes
export async function getStaticPaths() {
  const modules = import.meta.glob('../../data/events/**/*.json', { eager: true });

  const paths = Object.keys(modules)
    .map((filePath) => {
      const match = filePath.match(/\/([^/]+)\.json$/);
      const id = match ? match[1] : null;
      return id ? { params: { id } } : null;
    })
    .filter(Boolean);

  return paths;
}

const { params } = Astro;
const id = params.id;

const modules = import.meta.glob('../../data/events/**/*.json');
const matchKey = Object.keys(modules).find((k) => k.endsWith(`/${id}.json`));

let notFound = false;
let event = null;

if (!matchKey) {
  notFound = true;
} else {
  const mod = await modules[matchKey]();
  event = mod.default ?? mod;
}

const overview = event ? (event.overview ?? event) : null;
const details = event ? (event.details ?? {}) : {};
const pageTitle = event ? `${details.title ?? overview.title} — QUT AIML` : "Event not found";
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content={overview ? (overview.excerpt ?? details.longDescription ?? `Event details for ${overview.title}`) : "Event not found"} />
    <title>{pageTitle}</title>
  </head>

  <body class="background-dots">
    <Navigation />

    <main class="unique-event-space">
      {notFound ? (
        <section class="unique-event-card unique-event-notfound">
          <h1>Event not found</h1>
          <p>We couldn't find an event with the id <strong>{id}</strong>.</p>
          <p><a href="/events" class="unique-link">Back to events</a></p>
        </section>
      ) : (
        <article class="unique-event-card">
          <nav class="unique-nav">
            <a href="/events" class="unique-link">← Back to events</a>
          </nav>

          {/* TOP IMAGE */}
          {overview.image ? (
            <div class="unique-top-image-wrapper">
              <img src={overview.image} alt={overview.title} class="unique-top-image" />
            </div>
          ) : null}

          <header class="unique-header">
            <h1 class="unique-title">{details.title ?? overview.title}</h1>
            <div class="unique-meta">
              <time>{details.fullDate ?? overview.dateLabel ?? overview.date}</time>
              {details.time ? <span> · {details.time}</span> : null}
              {details.location ? <span> · {details.location}</span> : null}
            </div>
            <div class="unique-meta-divider"></div>

            {(overview.category || (details.tags && details.tags.length)) ? (
              <div class="unique-tags">
                {overview.category ? <span class="unique-tag">{overview.category}</span> : null}
                {(details.tags ?? []).map(tag => <span class="unique-tag">{tag}</span>)}
              </div>
            ) : null}
          </header>

          <section class="unique-body">
            <p>{details.longDescription ?? overview.excerpt}</p>

            {details.schedule ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Schedule</h3>
                <ul>
                  {details.schedule.map(item => <li>{item.time ? `${item.time} — ` : ''}{item.activity}</li>)}
                </ul>
              </div>
            ) : null}

            {details.agenda ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Agenda</h3>
                <ul>
                  {details.agenda.map(a => <li>{a.item}</li>)}
                </ul>
              </div>
            ) : null}

            {details.speakers ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Speakers</h3>
                <ul>
                  {details.speakers.map(s => <li>{s.name}{s.role ? ` — ${s.role}` : ''}</li>)}
                </ul>
              </div>
            ) : null}

            {details.format ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Format</h3>
                <p>{details.format}</p>
              </div>
            ) : null}

            {details.prizes ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Prizes</h3>
                <ul>
                  {details.prizes.map(p => <li>{p}</li>)}
                </ul>
              </div>
            ) : null}

            {details.registration ? (
              <div class="unique-registration">
                <h3 class="unique-section-title">Registration</h3>
                <p>{details.registration.required ? 'Registration required' : 'No registration required'}</p>
                {details.registration.link ? <p><a href={details.registration.link} class="unique-link">Register / More info</a></p> : null}
                {details.registration.price ? <p class="unique-price">Price: {details.registration.price}</p> : null}
              </div>
            ) : null}

            {details.documents ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Documents</h3>
                <ul>
                  {details.documents.map(d => <li><a href={d.url} class="unique-link">{d.label}</a></li>)}
                </ul>
              </div>
            ) : null}

            {details.gallery ? (
              <div class="unique-section">
                <h3 class="unique-section-title">Gallery</h3>
                <div class="unique-gallery">
                  {details.gallery.map(src => (
                    <div class="unique-gallery-item">
                      <img src={src} alt={overview.title} class="unique-gallery-image" />
                    </div>
                  ))}
                </div>
              </div>
            ) : null}
          </section>

          {details.contact ? (
            <footer class="unique-footer">
              <strong>Contact</strong>
              <div>
                {details.contact.email ? <div>Email: <a href={`mailto:${details.contact.email}`} class="unique-link">{details.contact.email}</a></div> : null}
                {details.contact.phone ? <div>Phone: {details.contact.phone}</div> : null}
              </div>
            </footer>
          ) : null}
        </article>
      )}
    </main>

    <Footer />
  </body>
</html>
