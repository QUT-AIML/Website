---
import "@/styles/global.css";
import "@/styles/learn/learn.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";

// -----------------------------
// Step 1: Import all learn JSON files
// -----------------------------
const rawLearnFiles = import.meta.glob('/public/data/learn/data/*.json', { eager: true });

// -----------------------------
// Step 2: Flatten files into a single array
// -----------------------------
let learnings = Object.values(rawLearnFiles)
  .map(mod => mod.default)
  .flat();

// -----------------------------
// Step 3: Generate slugs and resolve image paths
// -----------------------------
learnings = learnings.map(ev => {
  const title = ev.title ?? ev.slug ?? "untitled";

  // Slugify
  const slug = title
    .toLowerCase()
    .replace(/[–—]/g, "-")
    .replace(/[^\w\s-]/g, "")
    .trim()
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");

  // Resolve image path
  const image = ev.image
    ? `/data/learn/data/images/${ev.image}`
    : null;

  return {
    ...ev,
    slug,
    image,
    dateLabel: ev.date
      ? new Date(ev.date).toLocaleDateString("en-GB", {
          weekday: "long",
          day: "numeric",
          month: "short",
          year: "numeric"
        })
      : "",
  };
});

// -----------------------------
// Step 4: Unique categories
// -----------------------------
const allCategoriesSet = new Set();
learnings.forEach(ev => allCategoriesSet.add(ev.category ?? "Other"));
const categories = ["All", ...Array.from(allCategoriesSet).sort()];

// -----------------------------
// Step 5: Featured learnings
// -----------------------------
const featuredLearnings = learnings.filter(ev => ev.featured === true);

// -----------------------------
// Step 6: Utility function for dates
// -----------------------------
function formatDate(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat("en-GB", {
    weekday: "long",
    day: "numeric",
    month: "short",
    year: "numeric"
  }).format(date);
}

---


<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width" />
  <meta name="description" content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning." />
  <title>QUT AI & ML Society</title>
</head>

<body class="background-dots">
  <Navigation />

  <div class="content-wrapper learning-space">
    <!-- Featured Learnings -->
    {featuredLearnings.length > 0 && (
      <>
        <section class="pink-panel">
          <p class="pink-title">Featured Learning</p>
        </section>

        <div class="key-content">
            <section class="learning-panel">
              <section class="learning-grid">
                {featuredLearnings.map(ev => (
                  <article class="learn-card" data-category={ev.category} data-title={ev.title} data-date={ev.date} data-slug={ev.slug}>
                    <a href={`/learn/${ev.slug}`}>
                      <div class="card-media">
                        {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                      </div>
                      <div class="card-body">
                        <h3 class="card-title">{ev.title}</h3>
                        <div class="card-divider"></div>
                        <time class="card-date">{formatDate(ev.date)}</time>
                        <p class="card-description">{ev.description}</p>
                        <div class="card-footer">
                          <span class="card-view-more">View more →</span>
                        </div>
                      </div>
                    </a>
                  </article>
                ))}
              </section>
            </section>       
          </div>  
      </>
    )}

    <!-- All Learnings -->
    <section class="pink-panel panel-topspace">
      <p class="pink-title">Learn about AI & ML</p>
    </section>

    <div class="key-content">
      <section class="learning-controls">
        <div class="controls-row">
          <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="11" cy="11" r="7" />
              <line x1="16.65" y1="16.65" x2="21" y2="21" />
            </svg>
            <input id="learning-search" type="search" placeholder="Search" aria-label="Search learning" />
          </div>

          <div class="type-filter-wrapper">
            <span class="type-filter-label">Category:</span>
            <div id="type-filters" class="type-filter-pill">
              {categories.map(c => (
                <button class={`type-btn ${c === "All" ? "active" : ""}`} data-category={c} type="button">{c}</button>
              ))}
            </div>
          </div>

          <!-- FILTER POPOVER -->
            <div class="filters-wrapper">
              <button
                id="filters-toggle"
                aria-haspopup="true"
                aria-expanded="false"
                type="button"
                class="filters-toggle-btn"
              >
                <svg class="filters-toggle-icon" width="16" height="16" viewBox="0 0 24 24">
                  <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z"/>
                </svg>
              </button>

              <div
                id="filters-popover"
                role="dialog"
                aria-modal="false"
                class="filters-popover"
              >
                <div class="filters-popover-content">
                  <div class="filter-group">
                    <label for="sort-select-pop">Sort</label>
                    <select id="sort-select-pop">
                      <option value="none">None</option>
                      <option value="title-asc">Title A–Z</option>
                      <option value="title-desc">Title Z–A</option>
                      <option value="date-asc">Date Earliest → Latest</option>
                      <option value="date-desc">Date Latest → Earliest</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        
        <section class="learning-panel">
        <section id="learning-grid" class="learning-grid">
          {learnings.map(ev => (
            <article class="learn-card" data-category={ev.category} data-title={ev.title} data-date={ev.date} data-slug={ev.slug}>
              <a href={`/learn/${ev.slug}`}>
                <div class="card-media">
                  {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                </div>
                <div class="card-body">
                  <h3 class="card-title">{ev.title}</h3>
                  <div class="card-divider"></div>
                    <time class="card-date">{formatDate(ev.date)}</time>
                  <p class="card-description">{ev.description}</p>
                  <div class="card-footer">
                    <span class="card-view-more">View more →</span>
                  </div>
                </div>
              </a>
            </article>
          ))}
        </section>
      </section>
      
      <div id="learning-pagination"></div>

    </div>
  </div>

  <Footer />
</body>
</html>


<script type="module">
  // Vanilla JS pagination, search & category filter

  const searchInput = document.getElementById('learning-search');
  const grid = document.getElementById('learning-grid');
  const sortDropdown = document.getElementById('sort-select-pop');
  const filtersToggle = document.getElementById('filters-toggle');
  const filtersPopover = document.getElementById('filters-popover');
  let paginationContainer = document.getElementById('learning-pagination');

  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'learning-pagination';
    paginationContainer.style.textAlign = 'center';
    paginationContainer.style.marginTop = '2rem';
    grid.parentNode.appendChild(paginationContainer);
  }

  const LEARNINGS_PER_PAGE = 6;
  let currentPage = 1;
  let filteredCards = [];
  let categoryButtons = [];

  // STEP 1: Collect all learnings from the DOM but attach original API data
  const allCards = Array.from(grid.querySelectorAll('.learn-card')).map(card => ({
    apiData: {
      title: card.dataset.title,
      category: card.dataset.category,
      date: card.dataset.date,
      slug: card.dataset.slug,
      img: card.querySelector('img')?.src || null,
      description: card.querySelector('p')?.textContent || ''
    }
  }));

  // STEP 2: Determine all categories dynamically
  const allCategoriesSet = new Set(allCards.map(c => c.apiData.category || 'Other'));
  const allCategories = ['All', ...Array.from(allCategoriesSet).sort()];

  // STEP 3: Render category buttons
  function renderCategoryButtons(activeCategory = 'All') {
    const container = document.getElementById('type-filters');
    container.innerHTML = '';
    allCategories.forEach(c => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.dataset.category = c;
      btn.textContent = c;
      btn.className = `type-btn ${c === activeCategory ? 'active' : ''}`;
      btn.addEventListener('click', () => {
        categoryButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPage = 1;
        applyFilters();
      });
      container.appendChild(btn);
    });
    categoryButtons = Array.from(container.querySelectorAll('.type-btn'));
  }

  // STEP 4: Apply filters (search + category)
  function applyFilters() {
    const query = searchInput.value.trim().toLowerCase();
    const activeBtn = categoryButtons.find(b => b.classList.contains('active'));
    const selectedCategory = activeBtn ? activeBtn.dataset.category : 'All';

    filteredCards = allCards.filter(c => {
      const { title, description, category } = c.apiData;
      const matchesQuery = !query || title.includes(query) || description.toLowerCase().includes(query);
      const matchesCategory = selectedCategory === 'All' || category === selectedCategory;
      return matchesQuery && matchesCategory;
    });

    applySort();
    currentPage = 1;
    renderPage();
    renderPagination();
    renderNoResults();
  }

  // STEP 5: Sorting
  function applySort() {
    const sortOption = sortDropdown.value;
    filteredCards.sort((a, b) => {
      const aData = a.apiData;
      const bData = b.apiData;

      switch(sortOption) {
        case 'title-asc': return aData.title.localeCompare(bData.title);
        case 'title-desc': return bData.title.localeCompare(aData.title);
        case 'date-asc': return new Date(aData.date) - new Date(bData.date);
        case 'date-desc': return new Date(bData.date) - new Date(aData.date);
        default: return 0;
      }
    });
  }

  // STEP 6: Render current page
  function renderPage() {
    const start = (currentPage - 1) * LEARNINGS_PER_PAGE;
    const end = start + LEARNINGS_PER_PAGE;
    const cardsToShow = filteredCards.slice(start, end);

    grid.innerHTML = cardsToShow.map(c => {
      const { title, category, date, slug, img, description } = c.apiData;
      const formattedDate = new Date(date).toLocaleDateString('en-GB', {
        weekday: 'long',
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });

      return `
        <article class="learn-card" data-category="${category}" data-title="${title.toLowerCase()}" data-date="${date}" data-slug="${slug}">
          <a href="/learn/${slug}">
            <div class="card-media">${img ? `<img src="${img}" alt="${title}" />` : '<div class="no-image">No image</div>'}</div>
            <div class="card-body">
              <h3 class="card-title">${title}</h3>
              <div class="card-divider"></div>
              <time class="card-date">${formattedDate}</time>
              <p class="card-description">${description}</p>
              <div class="card-footer">
                <span class="card-view-more">View more →</span>
              </div>
            </div>
          </a>
        </article>
      `;
    }).join('');
  }

  // STEP 7: Pagination
  function renderPagination() {
    const totalPages = Math.ceil(filteredCards.length / LEARNINGS_PER_PAGE);
    if (totalPages <= 1) { 
      paginationContainer.innerHTML = ''; 
      return; 
    }

    let html = `<button class="pagination-btn" data-page="${currentPage-1}" ${currentPage===1?'disabled':''}>Prev</button>`;
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="pagination-btn ${i===currentPage?'active':''}" data-page="${i}">${i}</button>`;
    }
    html += `<button class="pagination-btn" data-page="${currentPage+1}" ${currentPage===totalPages?'disabled':''}>Next</button>`;

    paginationContainer.innerHTML = html;

    Array.from(paginationContainer.querySelectorAll('.pagination-btn')).forEach(btn => {
      btn.addEventListener('click', () => {
        let page = parseInt(btn.dataset.page);
        if (isNaN(page)) return;
        currentPage = Math.min(Math.max(page, 1), totalPages);
        renderPage();
        renderPagination();
      });
    });
  }

  // STEP 8: No results message
  function renderNoResults() {
    let msg = document.getElementById('no-learning-message');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'no-learning-message';
      msg.textContent = 'No learnings found';
      msg.style.textAlign = 'center';
      msg.style.padding = '2rem';
      msg.style.gridColumn = '1 / -1';
      grid.appendChild(msg);
    }
    msg.style.display = filteredCards.length === 0 ? 'block' : 'none';
  }

  // STEP 9: Event listeners
  searchInput.addEventListener('input', applyFilters);
  sortDropdown.addEventListener('change', applyFilters);
  filtersToggle.addEventListener('click', e => {
    e.stopPropagation();
    filtersPopover.style.display = filtersPopover.style.display === 'block' ? 'none' : 'block';
  });

  // STEP 10: Init
  renderCategoryButtons();
  applyFilters();
</script>
