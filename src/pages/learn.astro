---
import "@/styles/global.css";
import "@/styles/learn/learn.css";
import Navigation from "@/components/Navigation.astro";
import Footer from "@/components/Footer.astro";
import articlesIndex from "@/data/learn/index.js";

const articles = articlesIndex?.topics ?? [];

// Determine dynamic types
const preferred = ["Social", "Industry", "Projects", "Major"];
const allTypesSet = new Set();
articles.forEach(ev => {
  const t = (ev.type ?? ev.category ?? "Other").toString();
  if (t) allTypesSet.add(t);
});
const preferredExisting = preferred.filter(p => allTypesSet.has(p));
const remaining = Array.from(allTypesSet).filter(t => !preferredExisting.includes(t));
remaining.sort((a, b) => a.localeCompare(b));
const types = ["All", ...preferredExisting, ...remaining];

const today = new Date();
today.setHours(0, 0, 0, 0);

// Featured articles (upcoming)
const featuredArticles = articles
  .filter(ev => ev.featured)
  .filter(ev => {
    const articleDate = new Date(ev.date);
    articleDate.setHours(0, 0, 0, 0);
    return articleDate >= today;
  });
---

<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width" />
  <meta name="description" content="The QUT AI & ML Society is a student-led community exploring artificial intelligence and machine learning." />
  <title>QUT AIML</title>
</head>

<body class="background-dots">
  <Navigation />

  <div class="content-wrapper learning-space">
    <!-- Featured Articles -->
    {featuredArticles.length > 0 && (
      <>
        <section class="pink-panel">
          <p class="pink-title">Featured Articles</p>
        </section>
        <section class="featured-learning-panel">
          <div class="featured-learning-grid">
            {featuredArticles.map(ev => (
              <article class="article-card" data-category={ev.category} data-type={ev.type ?? ev.category ?? "Other"} data-title={ev.title.toLowerCase()} data-date={ev.date}>
                <a href={ev.url}>
                  <div class="card-media">
                    {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                  </div>
                  <div class="card-body">
                    <h3 class="card-title">{ev.title}</h3>
                    <div class="card-divider"></div>
                    <time class="card-date">{ev.dateLabel}</time>
                    <p class="card-description">{ev.excerpt}</p>
                    <div class="card-footer">
                      <span class="card-view-more">View more →</span>
                    </div>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </section>
      </>
    )}

    <!-- All Articles -->
    <section class="pink-panel">
      <p class="pink-title">Learn about AI & ML</p>
    </section>

    <div class="key-content">
      <section class="learning-controls">
        <div class="controls-row">
          <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="11" cy="11" r="7" />
              <line x1="16.65" y1="16.65" x2="21" y2="21" />
            </svg>
            <input id="learning-search" type="search" placeholder="Search" aria-label="Search learning" />
          </div>

          <div class="type-filter-wrapper">
            <span class="type-filter-label">Sort by:</span>
            <div id="type-filters" class="type-filter-pill">
              {types.map(t => (
                <button class={`type-btn ${t === "All" ? "active" : ""}`} data-type={t} type="button">{t}</button>
              ))}
            </div>
          </div>

          <div style="margin-left:auto; position:relative;">
            <button id="filters-toggle" aria-haspopup="true" aria-expanded="false" type="button" class="filters-toggle-btn">
              <svg class="filters-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z"/>
              </svg>
            </button>

            <div id="filters-popover" role="dialog" aria-modal="false" class="filters-popover">
              <div class="filters-popover-content">
                <div class="filter-group">
                  <label for="sort-select-pop">Sort</label>
                  <select id="sort-select-pop">
                    <option value="upcoming" selected>Upcoming articles</option>
                    <option value="past">Past articles</option>
                    <option value="title-asc">Title A–Z</option>
                  </select>
                </div>

                <div class="filter-actions">
                  <button id="filters-apply" type="button" class="btn-secondary">Apply</button>
                  <button id="filters-cancel" type="button" class="btn-secondary">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="learning-panel">
        <section id="learning-grid" class="learning-grid">
          {articles.map(ev => {
            const type = ev.type ?? ev.category ?? "Other";
            return (
              <article class="article-card" data-category={ev.category} data-type={type} data-title={ev.title.toLowerCase()} data-date={ev.date}>
                <a href={ev.url}>
                  <div class="card-media">
                    {ev.image ? <img src={ev.image} alt={ev.title} /> : <div class="no-image">No image</div>}
                  </div>
                  <div class="card-body">
                    <h3 class="card-title">{ev.title}</h3>
                    <div class="card-divider"></div>
                    <time class="card-date">{ev.dateLabel}</time>
                    <p class="card-description">{ev.excerpt}</p>
                    <div class="card-footer">
                      <span class="card-view-more">View more →</span>
                    </div>
                  </div>
                </a>
              </article>
            );
          })}
        </section>
      </section>

      <div id="learning-pagination"></div>
    </div>
  </div>

  <Footer />
</body>
</html>



    


<script type="module">
  const searchInput = document.getElementById('learning-search');
  const grid = document.getElementById('learning-grid');
  const sortSelectPop = document.getElementById('sort-select-pop');
  const filtersToggle = document.getElementById('filters-toggle');
  const filtersPopover = document.getElementById('filters-popover');
  const filtersApply = document.getElementById('filters-apply');
  const filtersCancel = document.getElementById('filters-cancel');
  let paginationContainer = document.getElementById('learning-pagination');

  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'learning-pagination';
    paginationContainer.style.textAlign = 'center';
    paginationContainer.style.marginTop = '2rem';
    grid.parentNode.appendChild(paginationContainer);
  }

  const ARTICLES_PER_PAGE = 6;
  let currentPage = 1;
  let currentSort = 'upcoming';
  let filteredCards = [];
  let typeButtons = [];

  function getCards() {
    return Array.from(grid.querySelectorAll('.article-card'));
  }

  function getTypesForFilteredCards() {
    const query = searchInput.value.trim().toLowerCase();
    const today = new Date(); today.setHours(0,0,0,0);

    const cards = getCards().filter(card => {
      const title = card.dataset.title || '';
      const excerpt = card.querySelector('p')?.textContent.toLowerCase() || '';
      const cardType = card.dataset.type || '';
      const cardDate = new Date(card.dataset.date); cardDate.setHours(0,0,0,0);

      const matchesQuery = !query || title.includes(query) || excerpt.includes(query);
      let matchesSort = true;
      if (currentSort === 'upcoming') matchesSort = cardDate >= today;
      if (currentSort === 'past') matchesSort = cardDate < today;

      return matchesQuery && matchesSort;
    });

    const typeSet = new Set(cards.map(c => c.dataset.type || 'Other'));
    const preferred = ["Social", "Industry", "Projects", "Major"];
    const preferredExisting = preferred.filter(p => typeSet.has(p));
    const remaining = Array.from(typeSet).filter(t => !preferredExisting.includes(t)).sort();
    const allTypes = [...preferredExisting, ...remaining];

    return allTypes.length <= 1 ? ['All'] : ['All', ...allTypes];
  }

  function renderTypeButtons(types) {
    const container = document.getElementById('type-filters');
    container.innerHTML = '';
    types.forEach(t => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.dataset.type = t;
      btn.textContent = t;
      btn.className = `type-btn ${t === 'All' ? 'active' : ''}`;
      btn.addEventListener('click', () => {
        typeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
      });
      container.appendChild(btn);
    });
    typeButtons = Array.from(container.querySelectorAll('.type-btn'));
  }

  function applyFilters() {
    const query = searchInput.value.trim().toLowerCase();
    const activeTypeBtn = typeButtons.find(b => b.classList.contains('active'));
    const selectedType = activeTypeBtn ? activeTypeBtn.dataset.type : 'All';
    const today = new Date(); today.setHours(0,0,0,0);

    filteredCards = getCards().filter(card => {
      const title = card.dataset.title || '';
      const excerpt = card.querySelector('p')?.textContent.toLowerCase() || '';
      const cardType = card.dataset.type || '';
      const cardDate = new Date(card.dataset.date); cardDate.setHours(0,0,0,0);

      const matchesQuery = !query || title.includes(query) || excerpt.includes(query);
      const matchesType = selectedType === 'All' || cardType === selectedType;

      let matchesSort = true;
      if (currentSort === 'upcoming') matchesSort = cardDate >= today;
      if (currentSort === 'past') matchesSort = cardDate < today;

      return matchesQuery && matchesType && matchesSort;
    });

    currentPage = 1;
    applySort();
    renderPage();
    renderPagination();

    let noArticlesMessage = document.getElementById('no-learning-message');
    if (!noArticlesMessage) {
      noArticlesMessage = document.createElement('div');
      noArticlesMessage.id = 'no-learning-message';
      noArticlesMessage.textContent = 'No articles found';
      noArticlesMessage.style.textAlign = 'center';
      noArticlesMessage.style.padding = '2rem';
      noArticlesMessage.style.gridColumn = '1 / -1';
      grid.appendChild(noArticlesMessage);
    }
    noArticlesMessage.style.display = filteredCards.length === 0 ? 'block' : 'none';

    const newTypes = getTypesForFilteredCards();
    renderTypeButtons(newTypes);
  }

  function applySort() {
    const today = new Date(); today.setHours(0,0,0,0);
    filteredCards.sort((a,b) => {
      const dateA = new Date(a.dataset.date); dateA.setHours(0,0,0,0);
      const dateB = new Date(b.dataset.date); dateB.setHours(0,0,0,0);

      if (currentSort === 'title-asc') return a.dataset.title.localeCompare(b.dataset.title);
      if (currentSort === 'upcoming') return dateA - dateB;
      if (currentSort === 'past') return dateB - dateA;
      return 0;
    });
  }

  function renderPage() {
    const start = (currentPage-1)*ARTICLES_PER_PAGE;
    const end = start + ARTICLES_PER_PAGE;
    getCards().forEach(c => c.style.display='none');
    filteredCards.slice(start,end).forEach(c => c.style.display='');
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredCards.length/ARTICLES_PER_PAGE);
    if(totalPages<=1){paginationContainer.innerHTML=''; return;}
    let html = `<button class="pagination-btn" data-page="${currentPage-1}" ${currentPage===1?'disabled':''}>Prev</button>`;
    for(let i=1;i<=totalPages;i++){
      html+=`<button class="pagination-btn" data-page="${i}" ${i===currentPage?'style="background:#1a73e8;color:#fff;"':''}>${i}</button>`;
    }
    html+=`<button class="pagination-btn" data-page="${currentPage+1}" ${currentPage===totalPages?'disabled':''}>Next</button>`;
    paginationContainer.innerHTML=html;
    Array.from(paginationContainer.querySelectorAll('.pagination-btn')).forEach(btn=>{
      btn.addEventListener('click',()=>{
        let page = parseInt(btn.dataset.page);
        if(page<1) page=1;
        if(page>totalPages) page=totalPages;
        currentPage=page;
        renderPage();
        renderPagination();
      });
    });
  }

  // Popover & events
  searchInput.addEventListener('input', applyFilters);
  filtersToggle.addEventListener('click', e => { e.stopPropagation(); filtersPopover.style.display==='block'?filtersPopover.style.display='none':filtersPopover.style.display='block'; });
  filtersApply.addEventListener('click', () => { currentSort = sortSelectPop.value; filtersPopover.style.display='none'; applyFilters(); });
  filtersCancel.addEventListener('click', () => { filtersPopover.style.display='none'; });

  // Initialize
  applyFilters();
</script>
